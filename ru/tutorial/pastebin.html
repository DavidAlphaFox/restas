<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Pastebin</title> <link rel="stylesheet" type="text/css" href="../static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Фрэймворк для разработки web-приложений на Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Начало</a>  </li><li> <a href="../overview.html">Обзор</a>  </li><li> <a href="../installation.html">Установка</a>  </li><li> <a href="contents.html">Введение</a> <ul> <li> <a href="hello-world.html">Hello World</a> </li><li> <strong>Pastebin</strong> </li> </ul> </li><li> <a href="../manual/contents.html">Руководство</a> <ul> <li> <a href="../manual/routes.html">Маршруты</a> </li><li> <a href="../manual/modules.html">Модули</a> </li><li> <a href="../manual/view.html">Представление</a> </li><li> <a href="../manual/special-pages.html">Специальные страницы</a> </li><li> <a href="../manual/decorators.html">Декораторы</a> </li><li> <a href="../manual/daemon.html">Демонизация</a> </li><li> <a href="../manual/slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="pastebin" class="document"><h1>Pastebin<a href="#pastebin" class="headerlink" title="Permalink to this headline">¶</a></h1><!-- -*- RST -*- -->
<a id="tutorial-pastebin" class="target" name="tutorial-pastebin"></a><p>В качестве демонстрации использования <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> для создания полноценного веб-приложения я хочу показать, как можно построить простейший pastebin-сервис.</p>
<div class="note admonition-note">
<p class="first">Примечание</p>
<p class="last">Из <a class="reference" href="http://ru.wikipedia.org/wiki/Pastebin"><span>Википедии</span></a>: pastebin или nopaste - веб-приложение, которое позволяет загружать отрывки текста, обычно фрагменты исходного кода, для возможности просмотра окружающими. Такой сервис очень популярен среди пользователей IRC сетей, где вставка больших фрагментов текста считается плохим тоном. Сервис также часто используется пользователями IM. В интернете существует множество pastebin веб-приложений, большинство из которых предоставляет подсветку синтаксиса различных языков программирования и специальной разметки.</p>
</div>
<p>Pastebin - это очень простое приложение, на примере которого, однако, можно показать основные принципы построения <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a>-приложений. Кроме того, это реальное приложение, которое используется на сайте <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a>, попробовать его в работе можно <a class="reference" href="http://lisper.ru/apps/format/"><span>здесь</span></a>.</p>
<p>Данный компонент должен обладать следующими функциональными возможностями:</p>
<ul>
<li><p class="first last">Форма для создания нового элемента</p>
</li>
<li><p class="first last">Список всех зарегистрированных элементов, щелчком на которых можно выполнить переход к просмотру этих элементов</p>
</li>
<li><p class="first last">Представление для просмотра каждого элемента</p>
</li>
<li><p class="first last">Подсветка синтаксиса</p>
</li>
</ul>
<p>Кроме того, он предназначен для использования в составе различных сайтов и таким образом должен обладать гибкими возможностями по конфигурации:</p>
<ul>
<li><p class="first last">Использовать предоставляемую сайтом систему аутентификации</p>
</li>
<li><p class="first last">Использовать предоставляемое сайтом хранилище данных</p>
</li>
<li><p class="first last">Предусматривать настройку способа отображения страниц</p>
</li>
</ul>
<div id="логическая-структура" class="section"><h2>Логическая структура<a href="#логическая-структура" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Данное приложение построено на основе классической модели MVC, с чётким разделением модели, контролёра и представления.</p>
<p>Настройка модуля производиться через <a class="reference" href="http://lisper.ru/articles/cl-vars"><span>специальные</span></a> (динамические) переменные (подробнее о настройке модулей с помощью динамических переменных смотрите раздел <a href="../manual/modules.html#модули">Модули</a>).</p>
<p>Хранить данные этого приложения можно множеством различных способов, поэтому определяется необходимый интерфейс и специальная переменная <span class="common-lisp-entity">*storage*</span>, с помощью которой внешнее приложение сможет указать используемый способ хранения данных. Для разработки и отладки нужно иметь функционирующую модель, которая реализуется тривиальным классом <span class="common-lisp-entity">memory-storage</span>, который обеспечивает хранения необходимых данных в памяти - такой подход позволяет вести разработку не акцентируя внимание на структуре базы данных, а вводить её только при реальной необходимости.</p>
<p>Обычно сайты имеют единую схему аутентификации, которая должна использоваться во всех компонентах. Поэтому разрабатываемый компонент не должен ничего знать об используемой схеме аутентификации. Фактически, для его функционирования ему необходимо знать только имя пользователя. Поэтому достаточно ввести одну единственную специальную переменную <span class="common-lisp-entity">*colorize-user-function*</span>, в которой будет храниться функция, вычисляющая имя пользователя.</p>
<p>Что бы компонент допускал гибкую настройку отображения страниц для отделения логики представления используется создаваемая <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> специальная переменная <span class="common-lisp-entity">*default-render-method*</span>, в которой храниться объект, ответственный за представление (подробнее об этом смотрите в разделе <a href="../manual/view.html#представление">Представление</a>). А для определения шаблонов страниц используется библиотека <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a>.</p>
</div>
<div id="физическая-структура" class="section"><h2>Физическая структура<a href="#физическая-структура" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Для упрощения понимания структуры кода используется следующее разбиение на файлы:</p>
<ul>
<li><p class="first last"><strong><span>defmodule.lisp</span></strong> - содержит определение модуля, а также специальных переменных, с помощью которых можно будет настроить поведение компонента</p>
</li>
<li><p class="first last"><strong><span>storage.lisp</span></strong> - содержит определения интерфейса, которому должна удовлетворять используемая модель данных, а также простейшую реализацию этой модели.</p>
</li>
<li><p class="first last"><strong><span>drawer.lisp</span></strong> - интерфейс и реализация по-умолчанию объекта drawer, который будет использоваться для установки значения специальной переменной <span class="common-lisp-entity">*default-render-method*</span></p>
</li>
<li><p class="first last"><strong><span>drawer.tmpl</span></strong> - файл с шаблонами в формате <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a></p>
</li>
<li><p class="first last"><strong><span>routes.lisp</span></strong> - центральная часть приложения, в которой определяется схема URL и код для обработки поступающих запросов</p>
</li>
</ul>
</div>
<div id="реализация" class="section"><h2>Реализация<a href="#реализация" class="headerlink" title="Permalink to this headline">¶</a></h2><div id="defmodule-lisp" class="section"><h3>defmodule.lisp<a href="#defmodule-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-module</span></i> <span class="keyword">#:restas.colorize</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">#:cl</span> <span class="keyword">#:iter</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:export</span> ..</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_in_pkg.htm" class="symbol">in-package</a> <span class="keyword">#:restas.colorize</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpar.htm" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*max-on-page*</span> 10</span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpar.htm" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*storage*</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpar.htm" class="symbol"><i><span class="symbol">defvar</span></i></a> <span class="special">*colorize-user-function*</span> #'<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren3">(<span class=""></span>)</span> <span class="string">"anonymous"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> colorize-user <span class="paren2">(<span class=""></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="special">*colorize-user-function*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_funcal.htm" class="symbol">funcall</a> <span class="special">*colorize-user-function*</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Здесь определяется новый модуль <strong><span>#:restas.colorize</span></strong> (при этом в целях экономии места опущен список экспортируемых символов) и введено несколько специальных переменных, которые будут использоваться для настройки модуля (для переменных <span class="common-lisp-entity">*max-on-page*</span> и <span class="common-lisp-entity">*colorize-user-function*</span> определены значения по-умолчанию), а также определена вспомогательная функция <span class="common-lisp-entity">colorize-user</span>, которая будет вычислять имя пользователя.</p>
</div>
<div id="storage-lisp" class="section"><h3>storage.lisp<a href="#storage-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Определение интерфейса, которому должен удовлетворять объект <span class="common-lisp-entity">*storage*</span>:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> storage-count-notes <span class="paren2">(<span class="">storage</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Колличество записей"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> storage-list-notes <span class="paren2">(<span class="">storage offset limit</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documenation</span> <span class="string">"Список записей начиная с offset, но колличеством не больше limit"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> storage-get-note <span class="paren2">(<span class="">storage id</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Получить записть по id"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> storage-add-note <span class="paren2">(<span class="">storage note</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Добавить новую запись"</span></span>)</span></span>)</span></div></p>
<p>Вспомогательный класс, для хранения информации об одной записи:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defcla.htm" class="symbol"><i><span class="symbol">defclass</span></i></a> note <span class="paren2">(<span class=""></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="paren3">(<span class="">id <span class="keyword">:initarg</span> <span class="keyword">:id</span> <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="keyword">:accessor</span> note-id</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">date <span class="keyword">:initarg</span> <span class="keyword">:date</span> <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="keyword">:accessor</span> note-date</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">author <span class="keyword">:initarg</span> <span class="keyword">:author</span> <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="keyword">:accessor</span> note-author</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">title <span class="keyword">:initarg</span> <span class="keyword">:title</span> <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="keyword">:accessor</span> note-title</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">lang <span class="keyword">:initarg</span> <span class="keyword">:lang</span> <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="keyword">:accessor</span> note-lang</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">code <span class="keyword">:initarg</span> <span class="keyword">:code</span> <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="keyword">:accessor</span> note-code</span>)</span></span>)</span></span>)</span></div></p>
<p>Реализация хранилища в памяти тривиальная, поэтому достаточно привести только определением класса:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defcla.htm" class="symbol"><i><span class="symbol">defclass</span></i></a> memory-storage <span class="paren2">(<span class=""></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="paren3">(<span class="">notes <span class="keyword">:initform</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a></span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">last-id <span class="keyword">:initform</span> 0</span>)</span></span>)</span></span>)</span></div></p>
<p>Установка переменной <span class="common-lisp-entity">*storage*</span> значения по-умолчанию:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_setf.htm" class="symbol">setf</a> <span class="special">*storage*</span> <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mk_ins.htm" class="symbol">make-instance</a> 'memory-storage</span>)</span></span>)</span></div></p>
</div>
<div id="routes-lisp" class="section"><h3>routes.lisp<a href="#routes-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p>В этом файле определяются обрабатываемые URL и управляющая логика. Поскольку за всю логику представления отвечает объект <span class="common-lisp-entity">*default-render-method*</span>, то обработчики маршрутов должны только собирать и подготавливать данные, которые после этого будут обрабатываться с помощью функции <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a>. Логики представления, как сказано выше, реализуется на основе библиотеки <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a>, которая в качестве входного формата данных использует <em><span>plist</span></em> (подробнее об использовании <em><span>property list</span></em> можно прочитать <a class="reference" href="http://lisper.ru/pcl/practical-a-simple-database"><span>здесь</span></a>), поэтому обработчики маршрутов генерируют данные в этом формате.</p>
<p>Пара вспомогательных функций, переводящих информацию о записи в формат <em><span>plist</span></em>:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> note-plist/short <span class="paren2">(<span class="">note</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:href</span> <span class="paren3">(<span class="">restas:genurl 'view-note <span class="keyword">:id</span> <span class="paren4">(<span class="">note-id note</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:date</span> <span class="paren3">(<span class="">local-time:format-timestring <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="paren4">(<span class="">note-date note</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> <span class="paren3">(<span class="">note-title note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="paren3">(<span class="">note-author note</span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defun.htm" class="symbol"><i><span class="symbol">defun</span></i></a> note-plist <span class="paren2">(<span class="">note</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_list_.htm" class="symbol">list*</a> <span class="keyword">:title</span> <span class="paren3">(<span class="">note-title note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:code</span> <span class="paren3">(<span class="">note-code note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:lang</span> <span class="paren3">(<span class="">note-lang note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">note-plist/short note</span>)</span></span>)</span></span>)</span></div></p>
<p>В этом коде наибольший интерес представляет вызов</p>
<p><div class="code"><span class="paren1">(<span class="">restas:genurl 'view-note <span class="keyword">:id</span> <span class="paren2">(<span class="">note-id note</span>)</span></span>)</span></div></p>
<p>Который генерирует URL для просмотра записи на основе имени маршрута ('view-node) и параметра :id.</p>
<div class="note admonition-note">
<p class="first">Примечание</p>
<p class="last">В системах на основе маршрутов не принято "ручное" создание URL, поскольку автоматическая генерация значительно повышает гибкость приложения и избавляет от многих потенциальных проблем. Помимо прочего в данном случае будет учтён базовый URL, по которому подключён модуль и который не известен на этапе разработки модуля.</p>
</div>
<p>Точка входа в приложение:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> main <span class="paren2">(<span class=""><span class="string">""</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">restas:redirect 'list-notes</span>)</span></span>)</span></div></p>
<p>Данный маршрут обрабатывает запрос к базовому URL, по которому подключён модуль, и просто перенаправляет на страницу со списком записей. Для перенаправления используется функция <a class="common-lisp-entity" href="../ref/index.html#restas-redirect">restas:redirect</a>, которая, подобно <a class="common-lisp-entity" href="../ref/index.html#restas-genurl">restas:genurl</a>, обрабатывает имя маршрута (и набор параметров, но у маршрута 'list-notes их нет), так что нет необходимости в явном указании URL.</p>
<p>Для отображения списка записей используется постраничное отображение, с ограничением количества записей на одной странице, которое не должно быть более <span class="common-lisp-entity">*max-on-page*</span> (эта переменная введена в <strong><span>defmodule.lisp</span></strong>). Поэтому, кроме самого списка записей необходимо собрать информацию об общем количество записей, а также предоставить ссылки на предыдущую и следующую страницы:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> list-notes <span class="paren2">(<span class=""><span class="string">"all"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let*</span></i></a> <span class="paren3">(<span class=""><span class="paren4">(<span class="">total-count <span class="paren5">(<span class="">storage-count-notes <span class="special">*storage*</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">start <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_max_m.htm" class="symbol">min</a> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_max_m.htm" class="symbol">max</a> <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_or.htm" class="symbol">or</a> <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_ignore.htm" class="symbol">ignore-errors</a> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_parse_.htm" class="symbol">parse-integer</a> <span class="paren4">(<span class="">hunchentoot:get-parameter <span class="string">"start"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total-count</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:title</span> <span class="string">"All notes"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:notes</span> <span class="paren4">(<span class="">iter <span class="paren5">(<span class="">for note in <span class="paren6">(<span class="">storage-list-notes <span class="special">*storage*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_1pl_1_.htm" class="symbol">1-</a> start</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="special">*max-on-page*</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">collect <span class="paren6">(<span class="">note-plist/short note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:first</span> start<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:total-count</span> total-count<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-before</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_eq_sle.htm" class="symbol">&lt;</a> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pl.htm" class="symbol">+</a> <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_1pl_1_.htm" class="symbol">1-</a> start</span>)</span> <span class="special">*max-on-page*</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total-count</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"~A?start=~A"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">restas:genurl 'list-notes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pl.htm" class="symbol">+</a> start <span class="special">*max-on-page*</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-after</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_eq_sle.htm" class="symbol">&gt;</a> start 1</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"~A?start=~A"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">restas:genurl 'list-notes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_max_m.htm" class="symbol">max</a> <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a__.htm" class="symbol">-</a> start <span class="special">*max-on-page*</span></span>)</span> 1</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Данный код несколько более запутан, чем следовало бы, по той причине, что реально обрабатываемый URL выглядит как :</p>
<pre class="literal-block">
all?start=n
</pre><p>(где n это порядковый номер первой записи на странице), а система маршрутов <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> пока не умеет учитывать GET-параметры запроса.</p>
<p>За просмотр конкретной записи отвечает следующий маршрут:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> view-note <span class="paren2">(<span class=""><span class="string">":id"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:parse-vars</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:id</span> #'<a href="http://www.lispworks.com/reference/HyperSpec/Body/f_parse_.htm" class="symbol">parse-integer</a></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">note-plist <span class="paren3">(<span class="">storage-get-note <span class="special">*storage*</span> id</span>)</span></span>)</span></span>)</span></div></p>
<p>Данный обработчик очень прост, но содержит один любопытный момент - параметр :parse-vars. Индефикатором записи является id, который должен быть целым числом. Данный код позволяет убедиться, что указанный URL содержит именно целое число и преобразует его из строкового представления, так что код обработчика работает уже с целочисленным значением.</p>
<p>Маршрут, отвечающий за показ формы создания записи ещё более тривиален:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> create-note <span class="paren2">(<span class=""><span class="string">"create"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:title</span> <span class="string">"Создать"</span></span>)</span></span>)</span></div></p>
<p>Данная форма будет поддерживать как сохранение записи, так и предварительный просмотр, поэтому для обработки соответствующего POST-запроса я использую два маршрута, обрабатывающих один и тот же URL:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> preview-note <span class="paren2">(<span class=""><span class="string">"create"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> #'<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"preview"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:title</span> <span class="paren3">(<span class="">hunchentoot:post-parameter <span class="string">"title"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="paren3">(<span class="">colorize-user</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:code</span> <span class="paren3">(<span class="">hunchentoot:post-parameter <span class="string">"code"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:lang</span> <span class="paren3">(<span class="">hunchentoot:post-parameter <span class="string">"lang"</span></span>)</span></span>)</span></span>)</span><br><br>
<br>
<span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> save-note <span class="paren2">(<span class=""><span class="string">"create"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> #'<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"save"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class=""><span class="paren4">(<span class="">author <span class="paren5">(<span class="">colorize-user</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> author<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">restas:redirect 'view-note<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:id</span> <span class="paren5">(<span class="">note-id <span class="paren6">(<span class="">storage-add-note<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="special">*storage*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mk_ins.htm" class="symbol">make-instance</a> 'note<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:code</span> <span class="paren2">(<span class="">hunchentoot:post-parameter <span class="string">"code"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> author<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:lang</span> <span class="paren2">(<span class="">hunchentoot:post-parameter <span class="string">"lang"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> <span class="paren2">(<span class="">hunchentoot:post-parameter <span class="string">"title"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hunchentoot:+http-forbidden+</span>)</span></span>)</span></span>)</span></div></p>
<p>Для выбора маршрута используется свойство :requirement, в котором проверяется какая команда (Save или Preview) была выбрана пользователем. Для проверки того, что пользователь имеет ли право сохранять запись используется <span class="common-lisp-entity">colorize-user</span> (которая была определена в <strong><span>defmodule.lisp</span></strong>) и если пользователь не авторизовался, то на попытку сохранить запись он получит статус <span class="common-lisp-entity">hunchentoot:+http-forbidden+</span>.</p>
</div>
<div id="drawer-lisp" class="section"><h3>drawer.lisp<a href="#drawer-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Все определённые выше маршруты возвращают данные в формате <em><span>plist</span></em>, поэтому для выбора шаблона, который должен отображать переданные данные, необходимо дополнительно использовать имя текущего маршрута, которое можно вычислить как:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:route-symbol <span class="special">restas:*route*</span></span>)</span></div></p>
<p>и для этого определен generic-метод:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> render-route-data <span class="paren2">(<span class="">drawer data route </span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Отображение страницы для указанного маршрута"</span></span>)</span></span>)</span></div></p>
<p>который можно будет специализировать с помощью квалификатора <em><span>eql</span></em> для каждого конкретного маршрута.</p>
<p>Что бы внешнее приложение могло переопределить общую тему оформления определяется generic-фукнция:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> finalize-page <span class="paren2">(<span class="">drawer data</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Формирование итоговой страницы"</span></span>)</span></span>)</span></div></p>
<p>Для подсветки синтаксиса в CL есть библиотека <a class="reference" href="http://www.cliki.net/colorize"><span>colorize</span></a>, которая очень хорошо подсвечивает код на Common Lisp, но, честно говоря, далека от идеала. Поэтому, что бы оставить возможность использовать другой инструмент, который, возможно, появится в будущем, определены следующие интерфейсы с реализацией по-умолчанию на базе <a class="reference" href="http://www.cliki.net/colorize"><span>colorize</span></a>:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> colorize <span class="paren2">(<span class="">drawer code lang</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Генерация html с подсветкой кода"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:method</span> <span class="paren3">(<span class="">drawer code lang</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">colorize::html-colorization lang code</span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> colorize-langs <span class="paren2">(<span class="">drawer</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Список поддерживаемых языков"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:method</span> <span class="paren3">(<span class="">drawer</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">iter <span class="paren4">(<span class="">for <span class="paren5">(<span class="">id . title</span>)</span> in <span class="paren5">(<span class="">colorize:coloring-types</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">collect <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:id</span> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_symb_2.htm" class="symbol">symbol-name</a> id</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> title</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Для того, что бы специализировать вызов <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a>, а также определить реализации объявленных интерфейсов нужен класс:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defcla.htm" class="symbol"><i><span class="symbol">defclass</span></i></a> drawer <span class="paren2">(<span class=""></span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span></div></p>
<p>Реализация <span class="common-lisp-entity">finalize-page</span> по-умолчанию просто вызывает одноименный шаблон:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> finalize-page <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> data</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">restas.colorize.view:finalize-page data</span>)</span></span>)</span></div></p>
<p>Теперь <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a> записывается следующим образом:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> restas:render-object <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class=""><span class="paren4">(<span class="">content <span class="paren5">(<span class="">render-route-data drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">restas:route-symbol <span class="special">restas:*route*</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">menu <span class="paren5">(<span class="">restas.colorize.view:main-menu<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:href-all</span> &nbsp;<span class="paren1">(<span class="">restas:genurl 'list-notes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-create</span> <span class="paren1">(<span class="">restas:genurl 'create-note</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">finalize-page drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:content</span> content<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:menu</span> menu<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:title</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Здесь происходит вызов <span class="common-lisp-entity">finalize-page</span> куда в формате <em><span>plist</span></em> передаются следующие данные:</p>
<ul>
<li><p class="first last"><strong><span>content</span></strong> - основное содержимое страницы, которое генерируется с помощью вызова <span class="common-lisp-entity">render-route-data</span></p>
</li>
<li><p class="first last"><strong><span>menu</span></strong> - ссылки на просмотр записей и создание новой записи, которые используются для показа общего для всех страниц меню</p>
</li>
<li><p class="first last"><strong><span>title</span></strong> - заголовок страницы, который извлекается из переданных данных</p>
</li>
</ul>
<p>Реализация <span class="common-lisp-entity">render-route-data</span> обрабатывает переданные данные с помощью шаблона, имя которого совпадет с именем переданного маршрута (здесь можно обнаружить использование известного "примата соглашения над конфигурацией"):</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> route</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_funcal.htm" class="symbol">funcall</a> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_find_s.htm" class="symbol">find-symbol</a> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_symb_2.htm" class="symbol">symbol-name</a> route</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="keyword">#:restas.colorize.view</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span></span>)</span></div></p>
<p>Для некоторых маршрутов необходима дополнительная обработка передаваемых данных, которая не может быть выполнена на стороне шаблонов, это достигается за счёт специализации на основе квалификатора <em><span>eql</span></em>:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a></span>)</span> <span class="paren3">(<span class="">route <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> 'view-note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_call_n.htm" class="symbol">call-next-method</a> drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_list_.htm" class="symbol">list*</a> <span class="keyword">:code</span> <span class="paren4">(<span class="">colorize drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:code</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:lang</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a></span>)</span> <span class="paren3">(<span class="">route <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> 'create-note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_call_n.htm" class="symbol">call-next-method</a> drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_list_.htm" class="symbol">list*</a> <span class="keyword">:langs</span> <span class="paren4">(<span class="">colorize-langs drawer</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a></span>)</span> <span class="paren3">(<span class="">route <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> 'preview-note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_call_n.htm" class="symbol">call-next-method</a> drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_list_.htm" class="symbol">list*</a> <span class="keyword">:langs</span> <span class="paren4">(<span class="">colorize-langs drawer</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:preview</span> <span class="paren4">(<span class="">colorize drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:code</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:lang</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route</span>)</span></span>)</span></div></p>
<p>Ну и наконец переменной <span class="common-lisp-entity">*default-render-method*</span> присваивается значение по-умолчанию:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_setf.htm" class="symbol">setf</a> <span class="special">*default-render-method*</span> <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mk_ins.htm" class="symbol">make-instance</a> 'drawer</span>)</span></span>)</span></div></p>
<p>Таким образом, для генерации реального контента используется достаточно сложная схема, которая с одной стороны полностью опирается на шаблоны, а с другой каждый её аспект определён как generic-функция, так что для изменения способа отображения достаточно определить класс, наследующий от <span class="common-lisp-entity">drawer</span>, и специализировать нужные функции.</p>
</div>
<div id="drawer-tmpl" class="section"><h3>drawer.tmpl<a href="#drawer-tmpl" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Компиляция файла c шаблонами производится кодом:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defpar.htm" class="symbol"><i><span class="symbol">defparameter</span></i></a> <span class="special">*colorize-template-path*</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_merge_.htm" class="symbol">merge-pathnames</a> <span class="string">"src/drawer.tmpl"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">asdf:component-pathname <span class="paren4">(<span class="">asdf:find-system '<span class="keyword">#:restas-colorize</span></span>)</span></span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">closure-template:compile-template <span class="keyword">:common-lisp-backend</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="special">*colorize-template-path*</span></span>)</span></div></p>
<p>А сам он имеет следующее содержание: :</p>
<pre class="literal-block">
{namespace restas.colorize.view}

{template finalizePage}
    &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
    {\n}
    &lt;html&gt;
        &lt;head&gt;
    	      &lt;meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /&gt;

            {if $title}
                &lt;title&gt;{$title}&lt;/title&gt;
            {/if}
        &lt;/head&gt;

        &lt;body&gt;
          {$menu |noAutoescape}
          
          {$content |noAutoescape}
        &lt;/body&gt;
    &lt;/html&gt;
{/template}

{template main-menu}
    &lt;ul class="colorize-top-menu"&gt;
        &lt;li&gt;
            &lt;a href="{$hrefAll}"&gt;Все записи&lt;/a&gt;
        &lt;/li&gt;

        &lt;li&gt;
            &lt;a href="{$hrefCreate}"&gt;Создать&lt;/a&gt;
        &lt;/li&gt;
   &lt;/ul&gt;
{/template}

{template show-note-info}
    &lt;div class="info"&gt;
        Автор: &lt;strong&gt;{$author}&lt;/strong&gt; - {$date}
    &lt;/div&gt;
{/template}
  
{template list-notes}
    &lt;div class="colorize-list-nav" &gt;
        {if $hrefAfter}&lt;a href="{$hrefAfter}"&gt;« Позже&lt;/a&gt;{/if}
        {$first} - {min($first + length($notes) - 1, $totalCount)} 
        из {$totalCount}  
        {if $hrefBefore}&lt;a href="{$hrefBefore}"&gt;Раньше »&lt;/a&gt;{/if}
    &lt;/div&gt;

    {foreach $note in $notes}
        &lt;div class="note"&gt;
            &lt;a href="{$note.href}"&gt;{$note.title != '' ? $note.title : '*notitle*'}&lt;/a&gt;
            {call show-note-info data="$note" /}
        &lt;/div&gt;
    {/foreach}
{/template}

{template view-note}
    &lt;div class="note-detail"&gt;
        &lt;strong&gt;{$title}&lt;/strong&gt;
        {call show-note-info data="all" /}
        &lt;div class="code"&gt;
            {$code |noAutoescape}
        &lt;/div&gt;
    &lt;/div&gt;
{/template}    
  
{template create-note}
    &lt;form method="post"&gt;
        &lt;textarea rows="30" name="code" cols="80" style="width: 100%"&gt;{$code}&lt;/textarea&gt;
        &lt;table style="text-align: left"&gt;
            &lt;tbody&gt;
                {if $preview and $author}
                    &lt;tr&gt;
                        &lt;th&gt;Описание:&lt;/th&gt;
                        &lt;td&gt;
                            &lt;input size="60" name="title" type="text" {if $title}value="{$title}"{/if}/&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                {/if}
                  
                &lt;tr&gt;
                    &lt;th&gt;Форматировать как:&lt;/th&gt;
                    &lt;td&gt;
                        &lt;select name="lang" &gt;
                            {foreach $l in $langs}
                                &lt;option {if $l.id == $lang}selected{/if} value="{$l.id}"&gt;{$l.title}&lt;/option&gt;
                            {/foreach}
                        &lt;/select&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
      
        &lt;input type="submit" value="Форматировать" name="preview" /&gt;
        {if $preview and $author}
            &lt;input type="submit" value="Сохранить" name="save" /&gt;
        {/if}

        {if $preview}
            &lt;h3&gt;Предварительный просмотр&lt;/h3&gt;
            &lt;div class="code"&gt;
                {$preview |noAutoescape}
            &lt;/div&gt;
        {/if}
   &lt;/form&gt;    
{/template}

{template preview-note}
    {call create-note data="all" /}
{/template}
</pre></div>
</div>
<div id="использование" class="section"><h2>Использование<a href="#использование" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Для использования описанного компонента на сайте <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> я использую следующий код:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defcla.htm" class="symbol"><i><span class="symbol">defclass</span></i></a> pastebin-drawer <span class="paren2">(<span class="">restas.colorize::drawer</span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> restas.colorize::finalize-page <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer pastebin-drawer</span>)</span> data</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">rulisp-finalize-page &nbsp;<span class="keyword">:title</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:title</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:css</span> '<span class="paren3">(<span class=""><span class="string">"style.css"</span> <span class="string">"colorize.css"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:content</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_concat.htm" class="symbol">concatenate</a> '<a href="http://www.lispworks.com/reference/HyperSpec/Body/a_string.htm" class="symbol">string</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:menu</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:content</span></span>)</span></span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">restas:mount-submodule rulisp-format <span class="paren2">(<span class=""><span class="keyword">#:restas.colorize</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*baseurl*</span> '<span class="paren3">(<span class=""><span class="string">"apps"</span> <span class="string">"format"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*max-on-page*</span> 15</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*storage*</span> <span class="special">*rulisp-db-storage*</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*colorize-user-function*</span> #'compute-user-login-name</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*default-render-method*</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mk_ins.htm" class="symbol">make-instance</a> 'pastebin-drawer</span>)</span></span>)</span></span>)</span></div></p>
<p>Здесь через динамическое связывание специальных переменных задаётся базовый URL, по которому подключается модуль, максимальное количество записей на странице, способ хранения данных, способ аутентификации, а также корректируется способ отображения, так что данный компонент не выбивается из общего стиля оформления.</p>
</div>
<div id="исходный-код" class="section"><h2>Исходный код<a href="#исходный-код" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Исходный код описанного приложения, который почти полностью приведён выше, доступен по адресу <a class="reference" href="http://github.com/archimag/restas-colorize"><span>http://github.com/archimag/restas-colorize</span></a>. Без учёта файла шаблонов размер исходного года - около 200 строк.</p>
</div>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>