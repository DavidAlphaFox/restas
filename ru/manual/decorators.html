<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Декораторы</title> <link rel="stylesheet" type="text/css" href="../_static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Фрэймворк для разработки web-приложений на Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Начало</a>  </li><li> <a href="../overview.html">Обзор</a>  </li><li> <a href="../installation.html">Установка</a>  </li><li> <a href="../tutorial/contents.html">Введение</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Руководство</a> <ul> <li> <a href="routes.html">Маршруты</a> </li><li> <a href="modules.html">Модули</a> </li><li> <a href="view.html">Представление</a> </li><li> <a href="special-pages.html">Специальные страницы</a> </li><li> <strong>Декораторы</strong> </li><li> <a href="daemon.html">Демонизация</a> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="декораторы" class="document"><h1>Декораторы<a href="#декораторы" class="headerlink" title="Permalink to this headline">¶</a></h1><!-- -*- RST -*- -->
<a id="manual-decorators" class="target" name="manual-decorators"></a><p>Одной из заманчивых возможностей приложений на базе <a class="reference" href="http://ru.wikipedia.org/wiki/WSGI"><span>WSGI</span></a> является использование middleware-прослоек. Для <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> аналогичные возможности предоставляют декораторы. Данная возможность основана на использовании класса <span class="common-lisp-entity">routes:proxy-route</span> для создания обёрток над маршрутами и переопределения их поведения с помощью специализации соответствующих generic-методов.</p>
<p><strong><span>Декоратор</span></strong> - функция, которая принимает маршрут и возвращает другой. Например, для запрета кэширования браузерами результатов HTTP-запросов можно использовать такой декоратор:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> no-cache-route <span class="paren2">(<span class="">routes:proxy-route</span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> process-route <span class="keyword">:before</span> <span class="paren2">(<span class=""><span class="paren3">(<span class="">route no-cache-route</span>)</span> bindings</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">setf <span class="paren3">(<span class="">hunchentoot:header-out <span class="keyword">:expires</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">hunchentoot:rfc-1123-date</span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">setf <span class="paren3">(<span class="">hunchentoot:header-out <span class="keyword">:cache-control</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"max-age=0, no-store, no-cache, must-revalidate"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> @no-cache <span class="paren2">(<span class="">route</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">make-instance 'no-cache-route <span class="keyword">:target</span> route</span>)</span></span>)</span></div></p>
<p>Теперь можно использовать данный декоратор при определении маршрута:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> main <span class="paren2">(<span class=""><span class="string">""</span> <span class="keyword">:decorators</span> '<span class="paren3">(<span class="">@no-cahe</span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="string">"&lt;h1&gt;Hello world!&lt;/h1&gt;"</span></span>)</span></div></p>
<p>Либо, его можно применить к модулю целиком</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-module</span></i> <span class="keyword">#:restas.hello-world</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">:cl</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:decorators</span> #'restas:@no-caсhe</span>)</span></span>)</span></div></p>
<p>Или даже при подключении субмодуля:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:mount-submodule test-hello-world <span class="paren2">(<span class=""><span class="keyword">#:hello-world</span> restas:@no-caсhe</span>)</span></span>)</span></div></p>
<p>Все маршруты, определённые с помощью <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, перед помещение в дерево диспетчеризации пропускаются через последовательность декораторов. В первую очередь для обработки маршрута используются декораторы указанные в <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, затем декораторы указанные в <a class="common-lisp-entity" href="../ref/index.html#restas-define-module">restas:define-module</a> и наконец декораторы указанные в <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a>. Таким образом, в дерево помещается не оригинальный объект класса <span class="common-lisp-entity">restas:route</span>, а цепочка вложенных друг в друга прокси-объектов.</p>
<p>Определение нового декоратора состоит из определения класса, наследующего от <span class="common-lisp-entity">routes:proxy-route</span>, специализации для него одного или нескольких generic-методов и определении функции для создания объектов этого класса из оригинальных объектов.</p>
<p>При определении подобным образом новых классов маршрутов имеет смысл специализировать следующие методы:</p>
<ul>
<li><p class="first"><span class="common-lisp-entity">routes:route-check-conditions</span> (route bindings) - вызывается после того, как шаблон URL маршрута будет сопоставлен URL-запроса и позволяет определить дополнительные ограничения. Если возвращается <a href="" class="common-lisp-entity">T</a>, то маршрут считается удовлетворяющим запросу, в случае <a href="" class="common-lisp-entity">NIL</a> маршрут отбрасывается и система переходит к рассмотрению следующего.</p>
</li>
<li><p class="first"><span class="common-lisp-entity">restas:process-route</span> (route bindings) - вызывается для реальной обработки запроса.</p>
</li>
</ul>
<p>Декораторы можно использовать, например, для:</p>
<ul>
<li><p class="first">Аутентификации/авторизации</p>
</li>
<li><p class="first">Тонкой настройки заголовков ответа</p>
</li>
<li><p class="first">Настройки окружения, в котором будет происходить обработка запроса</p>
</li>
</ul>
<p>Ниже тривиальный пример использования декоратора для требования HTTP-аутентификации при просмотре содержимого директории, опубликованного с помощью модуля <a class="reference" href="http://github.com/archimag/restas-directory-publisher"><span>restas-directory-publisher</span></a>.</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> http-auth-route <span class="paren2">(<span class="">routes:proxy-route</span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> routes:route-check-conditions <span class="paren2">(<span class=""><span class="paren3">(<span class="">route http-auth-route</span>)</span> bindings</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">and <span class="paren3">(<span class="">call-next-method</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">multiple-value-bind <span class="paren4">(<span class="">user password</span>)</span> <span class="paren4">(<span class="">hunchentoot:authorization</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">or <span class="paren5">(<span class="">and <span class="paren6">(<span class="">string= user <span class="string">"hello"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">string= password <span class="string">"world"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">hunchentoot:require-authorization</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> @http-auth-require <span class="paren2">(<span class="">route</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">make-instance 'http-auth-route <span class="keyword">:target</span> route</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">restas:mount-submodule -tmp- <span class="paren2">(<span class=""><span class="keyword">#:restas.directory-publisher</span> @http-auth-require</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*baseurl*</span> '<span class="paren3">(<span class=""><span class="string">"tmp"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*directory*</span> #P<span class="string">"/tmp/"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*autoindex*</span> t</span>)</span></span>)</span></div></p>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>