<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Маршруты</title> <link rel="stylesheet" type="text/css" href="../static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Фрэймворк для разработки web-приложений на Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Начало</a>  </li><li> <a href="../overview.html">Обзор</a>  </li><li> <a href="../installation.html">Установка</a>  </li><li> <a href="../tutorial/contents.html">Введение</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Руководство</a> <ul> <li> <strong>Маршруты</strong> </li><li> <a href="modules.html">Модули</a> </li><li> <a href="view.html">Представление</a> </li><li> <a href="special-pages.html">Специальные страницы</a> </li><li> <a href="decorators.html">Декораторы</a> </li><li> <a href="daemon.html">Демонизация</a> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="маршруты" class="document"><h1>Маршруты<a href="#маршруты" class="headerlink" title="Permalink to this headline">¶</a></h1><a id="manual-routes" class="target" name="manual-routes"></a><p>Идея маршрута (англ. - route) впервые появилась в <a class="reference" href="http://rubyonrails.org/"><span>Ruby On Rails</span></a> и быстро обрела популярность в других веб-фреймворках. Также, концептуально очень близкой системой, является <a class="reference" href="http://docs.djangoproject.com/en/dev/topics/http/urls/"><span>URLConf</span></a> в <a class="reference" href="http://www.djangoproject.com/"><span>Django</span></a>. В последующих разработках наиболее мощной реализацией данной идеи, вероятно, является <a class="reference" href="http://routes.groovie.org/"><span>http://routes.groovie.org/</span></a>, используемая в <a class="reference" href="http://pylonshq.com/"><span>Pylons</span></a>.</p>
<p>Маршруты отвечают за ключевую проблему веб-разработки: сопоставление кода и URL. Например, какой код должен отвечать за обработку запросов по адресу "/blog/2008/01/08" или "/login"? Во многих фреймворках используется фиксированная система диспетчеризации, например "/A/B/C" означает прочитать файл "C" в каталоге "B", или вызвать метод "С" класса "B" в модуле "A". Это работает прекрасно до тех пор, пока не возникает необходимости в реорганизации кода, и выясняется, что закладки пользователей стали недействительны. Кроме того, если вы хотите переделать адреса (например, создать раздел в подразделе), то нужно изменить уже отлаженную логику по генерации ссылок внутри сайта.</p>
<p>Маршруты предлагают иной подход. Вы определяете шаблоны URL и связываете их со своим кодом. Если вы измените свое решение по поводу конкретного URL, то просто поменяйте шаблон URL - код по-прежнему будет работать отлично и не понадобится менять какую-либо логику.</p>
<div id="id1" class="section"><h2>cl-routes<a href="#id1" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Routes является ключевой концепцией <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a>, а их реализация основана на библиотеке <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a>.</p>
<p>Вот несколько возможных шаблонов URL для библиотеки <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> :</p>
<pre class="literal-block">
/forum/:chapter/:topic/:message
/forum/archives/:year/:month/:day
/forum/:chapter/rss
</pre><p>Или с объединением строк :</p>
<pre class="literal-block">
/book/:(name)-:(chapter).html
/:(feed).:(format)
</pre><p>Также поддерживаются wildcard-параметры (с тем ограничением, что такой параметр может использоваться в шаблоне только один раз) :</p>
<pre class="literal-block">
/mydoc/*items
/*path/rss
</pre><p>Большинство реализаций маршрутов (включая системы диспетчеризации <a class="reference" href="http://rubyonrails.org/"><span>Ruby On Rails</span></a>, <a class="reference" href="http://www.djangoproject.com/"><span>Django</span></a> и <a class="reference" href="http://pylonshq.com/"><span>Pylons</span></a>) хранят их в простом списке, а поиск подходящего маршрута ведут прямым перебором до первого совпадения. Обычно, при этом для сопоставления запроса маршруту используются регулярные выражения. Так что, для больших сайтов, имеющих сотни (а то и тысячи) маршрутов, система диспетчеризации запросов может оказаться узким местом, заметно снижающим общую производительность. <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> компилирует все маршруты в одно дерево, ведь поиск в дереве для большинства реальных сайтов будет заметно более эффективным, а вместо регулярных выражений использует легковесный механизм унификации.</p>
<p>Кроме того, в отличие от вышеупомянутых систем, в <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> маршрут это не строка, а объект класса <span class="common-lisp-entity">routes:route</span>, для которого можно специализировать <a class="reference" href="http://www.lispworks.com/documentation/HyperSpec/Body/26_glo_g.htm#generic_function"><span>generic</span></a>-метод <span class="common-lisp-entity">routes:routes:route-check-conditions</span>, что позволяет осуществлять произвольные проверки при сопоставлении маршрута запросу. Данная возможность используется в <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> для реализации более гибкой системы диспетчеризации.</p>
<p>При задании маршрутов всегда возможны конфликты, когда один и тот же URL соответствует нескольким шаблонам. В системах с последовательным поиском подходящего маршрута всегда выбирается первый, <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> пытается выбрать наиболее специальный, например тот, в котором больше переменных, или который имеет более длинную статическую часть. Точного описания алгоритма разрешения коллизий сейчас нет, но обычно с этим нет никаких проблем: поведение системы вполне разумно и по большей части соответствует интуитивным ожиданиям.</p>
</div>
<div id="использование" class="section"><h2>Использование<a href="#использование" class="headerlink" title="Permalink to this headline">¶</a></h2><p>В <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> для создания маршрутов используется макрос <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, например:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> article <span class="paren2">(<span class=""><span class="string">"articles/:author/:item"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:get</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:content-type</span> <span class="string">"text/plain"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_format.htm" class="symbol">format</a> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a> <span class="string">"Author: ~A~Article: ~A"</span> author item</span>)</span></span>)</span></div></p>
<p>Т.е. в одном месте задаётся и шаблон URL, и обработчик, при этом в теле обработчика сразу же доступны переменные, заданные в шаблоне URL. Вложенный обработчик, по-умолчанию, может вернуть <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_string.htm" class="common-lisp-entity">string</a> или "octets <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_array.htm" class="common-lisp-entity">array</a>", либо целое число (которое интерпретируется как код статуса ответа), либо <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pn.htm" class="common-lisp-entity">pathname</a> (в этом случае вызывается <span class="common-lisp-entity">hunchentoot:handle-static-file</span>, которая, в отличие от систем на базе Ruby или Python, работает достаточно быстро и реальной необходимости в дополнительных серверах для "статики", таких как <a class="reference" href="http://sysoev.ru/nginx/"><span>nginx</span></a>, обычно просто нет).</p>
<p>При определении маршрута через <span class="common-lisp-entity">restas:define-route</span> необходимо указать <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_symbol.htm" class="common-lisp-entity">symbol</a> (в приведённом примере - 'article), который будет является его именем. Во-первых, это даёт возможность в любой момент переопределить маршрут (в том числе и шаблон URL, лишь бы имя оставалось неизменным) простой отправкой кода в REPL (например, с помощью M-C-x в <a class="reference" href="http://common-lisp.net/project/slime/"><span>SLIME</span></a>). Во-вторых, это позволяет использовать данный <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_symbol.htm" class="common-lisp-entity">symbol</a> для генерации URL:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:genurl 'article<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="string">"archimag"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:item</span> <span class="string">"introduction-to-routes"</span></span>)</span></div></p>
<p>или для перенаправления:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:redirect 'article<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="string">"archimag"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:item</span> <span class="string">"introduction-to-routes"</span></span>)</span></div></p>
<p>Для одного и того же шаблона URL можно создать несколько маршрутов, накладывая на них дополнительные ограничения.</p>
<div id="ограничение-по-типу-http-запроса" class="section"><h3>Ограничение по типу HTTP-запроса<a href="#ограничение-по-типу-http-запроса" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Указывается с помощью параметра :method (по-умолчанию, :get) макроса <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, например:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> view-page <span class="paren2">(<span class=""><span class="string">":page"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;...</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> change-page <span class="paren2">(<span class=""><span class="string">":page"</span> <span class="keyword">:method</span> <span class="keyword">:post</span></span>)</span><br>&nbsp;&nbsp;&nbsp;...</span>)</span></div></p>
<p>Здесь маршруты view-page и change-page обслуживают один и тоте же URL, но view-page отвечает за обработку GET-запросов, а change-page обрабатывает POST-запросы.</p>
</div>
<div id="контроль-параметров-url" class="section"><h3>Контроль параметров URL<a href="#контроль-параметров-url" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Часто необходимо накладывать ограничения на параметры шаблона URL, например, по типу, или преобразовывать их из строкового представления в какие-либо объекты. Для этого используется параметр :parse-vars макроса <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, например:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> myroute <span class="paren2">(<span class=""><span class="string">"/foo/:bar/:id/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:parse-vars</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:bar</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren5">(<span class="">str</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">check-bar str</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:id</span> #'<a href="http://www.lispworks.com/reference/HyperSpec/Body/f_parse_.htm" class="symbol">parse-integer</a></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span></div></p>
<p>Здесь параметр id парсится как целое, bar проверяется с помощью функции #'check-bar, а page оставляется как есть. Если функция разбора возвращает <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="common-lisp-entity">NIL</a> или генерирует ошибку, то маршрут считается не удовлетворяющим условию и отбрасывается. В случае успеха в теле маршрута доступно уже распарсенное значение параметра, которое возвращается указанной функцией.</p>
<a id="manual-routes-requirement" class="target" name="manual-routes-requirement"></a></div>
<div id="произвольное-ограничение" class="section"><h3>Произвольное ограничение<a href="#произвольное-ограничение" class="headerlink" title="Permalink to this headline">¶</a></h3><p>С помощью параметра :requirement макроса <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a> можно указать произвольную функцию, которая будет вызываться при проверке маршрута. Если она возвращает <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="common-lisp-entity">NIL</a>, то маршрут считается не соответствующим запросу.</p>
<p>Например, в <a class="reference" href="http://github.com/archimag/restas-wiki"><span>restas-wiki</span></a> для обработки формы редактирования на wiki-странице используется такой код:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">define-route</span></i> edit-wiki-page/preview <span class="paren2">(<span class=""><span class="string">"edit/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"preview"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">define-route</span></i> edit-wiki-page/cancel <span class="paren2">(<span class=""><span class="string">"edit/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"cancel"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">define-route</span></i> edit-wiki-page/save <span class="paren2">(<span class=""><span class="string">"edit/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"save"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span></div></p>
<p>Здесь маршруты edit-wiki-page/preview, edit-wiki-page/cancel и edit-wiki-page/save отвечают за нажатие в форме кнопок Preview, Cancel и Save соответственно.</p>
</div>
</div>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>