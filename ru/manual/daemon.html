<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Демонизация</title> <link rel="stylesheet" type="text/css" href="../_static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Фрэймворк для разработки web-приложений на Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Начало</a>  </li><li> <a href="../overview.html">Обзор</a>  </li><li> <a href="../installation.html">Установка</a>  </li><li> <a href="../tutorial/contents.html">Введение</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Руководство</a> <ul> <li> <a href="routes.html">Маршруты</a> </li><li> <a href="modules.html">Модули</a> </li><li> <a href="view.html">Представление</a> </li><li> <a href="special-pages.html">Специальные страницы</a> </li><li> <a href="decorators.html">Декораторы</a> </li><li> <strong>Демонизация</strong> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="демонизация" class="document"><h1>Демонизация<a href="#демонизация" class="headerlink" title="Permalink to this headline">¶</a></h1><a id="manual-daemon" class="target" name="manual-daemon"></a><p>При развертывании Common Lisp приложения (например, сайта) на сервере под управлением GNU/Linux возникает проблема организации lisp-демона, что связано с некоторыми техническими проблемами, которые, вероятно, могут вызвать у начинающих некоторое непонимание (или даже ужас).</p>
<p>Корень этих проблем в том, что обычно lisp процесс не может быть оторван от терминала (причины этого восходят к тем далёким временам, когда компьютеры были большими...) и при закрытии стандартного потока ввода немедленно завершает свою работу.</p>
<p>Для решения этой проблемы известно несколько крайне неудобных и ненадёжных методов (см. <a class="reference" href="http://www.cliki.net/swank-daemon"><span>swank-daemon</span></a> и <a class="reference" href="http://www.cliki.net/detachtty"><span>detachtty</span></a>). Но для развёртывания веб-приложений на базе <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a>, использующих <a class="reference" href="http://www.sbcl.org/"><span>SBCL</span></a> в GNU/Linux, есть простой и удобный инструмент: скрипт <a class="reference" href="http://github.com/archimag/restas/blob/master/contrib/restas-daemon.lisp"><span>restas-daemon.lisp</span></a>, который находится в директории contrib пакета <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a>. Создать демона с помощью этого скрипта очень просто: :</p>
<pre class="literal-block">
sbcl --load /path/to/restas/contrib/restas-daemon.lisp /path/to/daemon.conf COMMAND
</pre><p>Как видно, данный скрипт принимает два параметра: путь к файлу конфигурации демона и имя команды. Поддерживаются следующие команды:</p>
<ul>
<li><p class="first"><strong><span>start</span></strong> - запуск</p>
</li>
<li><p class="first"><strong><span>stop</span></strong> - остановка</p>
</li>
<li><p class="first"><strong><span>restart</span></strong> - рестарт</p>
</li>
<li><p class="first"><strong><span>kill</span></strong> - убийство, если почему-то демон не хочет останавливаться с помощью stop</p>
</li>
<li><p class="first"><strong><span>zap</span></strong> - удалят pid-файл, это может потребоваться, если демон был остановлен как-нибудь грубо</p>
</li>
<li><p class="first"><strong><span>nodaemon</span></strong> - в основном тоже, что и start (в том числе происходит смена прав и т.п.), но при этом процесс не делает себе fork и не отключается от терминала, что даёт возможность наблюдать весь его вывод - удобно для отладки демона.</p>
</li>
</ul>
<p>Файл конфигурации демона может содержать определение нескольких переменных, влияющих на поведение демона, вот полный конфиг моего домашнего демона:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*name*</span> <span class="string">"homesite"</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*user*</span> <span class="string">"andrey"</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*swankport*</span> 9000</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*asdf-central-registry*</span><br>&nbsp;'<span class="paren2">(<span class="">#P<span class="string">"/usr/share/common-lisp/systems/"</span> #P<span class="string">"/home/andrey/development/common-lisp/systems/"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*asdf-load-systems*</span> '<span class="paren2">(<span class=""><span class="keyword">#:homesite</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*sites*</span> &nbsp;'<span class="paren2">(<span class=""><span class="paren3">(<span class=""><span class="keyword">#:homesite</span> nil 80</span>)</span></span>)</span></span>)</span></div></p>
<p>Возможны следующие параметры:</p>
<ul>
<li><p class="first"><span class="common-lisp-entity">*name*</span> - имя демона, в данный момент единственный обязательный параметр</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*user*</span> - имя пользователя, от которого должен работать демон, по-умолчанию совпадает с именем демона</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*group*</span> - группа пользователя</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*fasldir*</span> - путь к каталогу, в который будут складываться fasl-файлы, по-умолчанию определяется из имени демона как</p>
<p><div class="code"><span class="paren1">(<span class="">format nil <span class="string">"/var/cache/~A/fasl/"</span> <span class="special">*name*</span></span>)</span></div></p>
</li>
<li><p class="first"><span class="common-lisp-entity">*pidfile*</span> - pid-файла демона, по-умолчанию</p>
<p><div class="code"><span class="paren1">(<span class="">format nil <span class="string">"/var/run/~A/~A.pid"</span> <span class="special">*name*</span> <span class="special">*name*</span></span>)</span></div></p>
</li>
<li><p class="first"><span class="common-lisp-entity">*swankport*</span> - порт, на котором следует запускать swank, если не указан или nil, то swank не запускается</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*default-host-redirect*</span> - в <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> сайты запускаются с помощью <span class="common-lisp-entity">restas:start-site</span>, при этом можно указать имя хоста (аналог виртуальных хостов), данная переменная указывает хост, на который будет производиться редирект, если для хоста запроса нет сайта, например, на <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> можно попасть набрав в браузере <a class="reference" href="http://www.lisper.ru/"><span>http://www.lisper.ru/</span></a>, <a class="reference" href="http://lisp.catap.ru/"><span>http://lisp.catap.ru/</span></a> или просто прямой адрес, все такие запросы переплавляются на <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a>.</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*asdf-central-registry*</span> - список директорий, в которых будет производиться поиск систем</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*asdf-load-systems*</span> - список систем, которые необходимо загрузить при старте демона</p>
</li>
<li><p class="first"><span class="common-lisp-entity">*sites*</span> - список сайтов, которые необходимо запустить при запуске демона с помощью функции <a class="common-lisp-entity" href="../ref/index.html#restas-start">restas:start</a>. В качестве сайта может быть указано просто имя модуля <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a>, либо список, содержащий имя модуля, имя хоста и порт (а также, при необходимости в защищённом соединении по протоколу SSL, может быть указан 4-ый параметр с соответствующими настройками, см. ниже). Например, сайт <a class="reference" href="http://restas.lisper.ru"><span>http://restas.lisper.ru</span></a> и сайт <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> запускаются в одном процессе, а в конфиге демона переменная <span class="common-lisp-entity">*sites*</span> определена так:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*sites*</span><br>&nbsp;&nbsp;'<span class="paren2">(<span class=""><span class="paren3">(<span class=""><span class="keyword">#:rulisp</span> <span class="string">"lisper.ru"</span> 80</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><span class="keyword">#:rulisp.restas</span> <span class="string">"restas.lisper.ru"</span> 80</span>)</span></span>)</span></span>)</span></div></p>
<p>При использовании безопасного соединения, для сайта lisper.ru настройки могли бы быть такими:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*sites*</span><br>&nbsp;&nbsp;'<span class="paren2">(<span class=""><span class="paren3">(<span class=""><span class="keyword">#:rulisp</span> <span class="string">"lisper.ru"</span> 443 <span class="paren4">(<span class=""><span class="string">"/path/to/ssl_cert.cer"</span> <span class="string">"/path/to/private.key"</span> <span class="string">"your_pass"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><span class="keyword">#:rulisp.restas</span> <span class="string">"restas.lisper.ru"</span> 80</span>)</span></span>)</span></span>)</span></div></p>
<p>Если для использования ключа пароль не требуется, то в списке с SSL-настройками третий элемент "your_pass" использовать не нужно.</p>
</li>
</ul>
<p>Для систем на базе Gentoo есть специальная поддержка. При установке <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> с помощью <a class="reference" href="http://github.com/archimag/archimag-lisp-overlay"><span>archimag-lisp-overlay</span></a> в каталог /etc/init.d/ добавляется скрипт restas.lo. Теперь, для создания initd-скрипта необходимо создать симлинк на этот файл и создать конфигурационный файл в /etc/conf.d/, например: :</p>
<pre class="literal-block">
cd /etc/init.d/
ln -s restas.lo homesite
emacs /etc/conf.d/homesite.conf
/etc/init.d/homesite start
</pre></div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>