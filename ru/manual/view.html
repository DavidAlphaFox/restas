<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Представление</title> <link rel="stylesheet" type="text/css" href="../static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Фрэймворк для разработки web-приложений на Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Начало</a>  </li><li> <a href="../overview.html">Обзор</a>  </li><li> <a href="../installation.html">Установка</a>  </li><li> <a href="../tutorial/contents.html">Введение</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Руководство</a> <ul> <li> <a href="routes.html">Маршруты</a> </li><li> <a href="modules.html">Модули</a> </li><li> <strong>Представление</strong> </li><li> <a href="special-pages.html">Специальные страницы</a> </li><li> <a href="decorators.html">Декораторы</a> </li><li> <a href="daemon.html">Демонизация</a> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="представление" class="document"><h1>Представление<a href="#представление" class="headerlink" title="Permalink to this headline">¶</a></h1><!-- -*- RST -*- -->
<a id="manual-view" class="target" name="manual-view"></a><p>Отделение логики приложения от логики преставления является мощной и полезной техникой, часто используемой при разработке веб-приложений. <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> не обязывает использовать подобное разделение, но при желании оно обеспечивается за счёт generic-функции:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defgen.htm" class="symbol"><i><span class="symbol">defgeneric</span></i></a> restas:render-object <span class="paren2">(<span class="">drawer object</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Render object via drawer"</span></span>)</span></span>)</span></div></p>
<p>которая всегда вызывается для обработки данных, возвращаемых обработчиками маршрутов (определяемых с помощью <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>). Здесь видно, что для генерации контента используется два объекта: drawer и данные, так что можно говорить о полноценном разделении логики и представления, ну а <a class="reference" href="http://lisper.ru/pcl/object-reorientation-generic-functions"><span>мультиметоды</span></a> CL, делают подобный подход весьма мощным. Используемый drawer указывается в переменной модуля <span class="common-lisp-entity">*default-render-method*</span> и по-умолчанию установлен в nil. В <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> определены специализации <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a>, которые в качестве данных могу принимать:</p>
<ul>
<li><p class="first last"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_string.htm" class="common-lisp-entity">string</a> или <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_array.htm" class="common-lisp-entity">array</a> octets - данные просто отдаются клиенту без какой-либо дополнительной обработки</p>
</li>
<li><p class="first last"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pn.htm" class="common-lisp-entity">pathname</a> - файл отдаётся клиенту с помощью <span class="common-lisp-entity">hunchentoot:handle-static-file</span></p>
</li>
<li><p class="first last">integer - результат интерпретируется как HTTP-статус и клиенту отдаётся соответствующая специальная страница</p>
</li>
<li><p class="first last">В прочих случаях сообщается об ошибке</p>
</li>
</ul>
<p>Кроме того, определён метод обобщённой функции <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a>, для случая, когда аргуметом drawer является функция, a качестве данных:</p>
<ul>
<li><p class="first last"><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_pn.htm" class="common-lisp-entity">pathname</a> или integer - вызывается обработчик по-умолчанию (данные просто отдаются клиенту без обработки)</p>
</li>
<li><p class="first last">В прочих случаях с помощью funcall вызывается указанная функция для обработки переданных данных и результат отдаётся клиенту</p>
</li>
</ul>
<p>Кроме этого, определена специализация, когда в качестве drawer передаётся произвольный <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_pkg.htm" class="common-lisp-entity">package</a>. Эта возможность имеет следующее обоснование:</p>
<ul>
<li><p class="first last">Каждый маршрут является именованным и связан с <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_symbol.htm" class="common-lisp-entity">symbol</a></p>
</li>
<li><p class="first last">Почти всегда для логики представления автор использует <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a>, которая компилирует шаблоны в функции, для которых создаётся отдельный <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_pkg.htm" class="common-lisp-entity">package</a></p>
</li>
</ul>
<p>Если следовать небольшому соглашению и именовать шаблоны так же, как и маршруты, то можно в качестве <span class="common-lisp-entity">*default-render-method*</span> указать пакет с функциями шаблонов, и тогда <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> для работы с данными, полученными от обработчикика маршрута, будет автоматически вызывать функцию-шаблон с тем же именем из пакета с шаблонами. Вот такое небольшое волшебство, реализованное весьма простым и понятным образом. Поскольку, технически это всего лишь специализация <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a>, то её можно использовать и другими способами, например, сейчас в <a class="reference" href="http://github.com/archimag/restas-colorize"><span>restas-colorize</span></a> (аналог pastebin, в работе его можно посмотреть на <a class="reference" href="http://lisper.ru/apps/format/"><span>http://lisper.ru/apps/format/</span></a>), для генерации разметки используется следующий код:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-default-render-method</span></i> <span class="paren2">(<span class="">obj</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">closure-template.standard:xhtml-strict-frame<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:title</span> <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> obj <span class="keyword">:title</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:body</span> <span class="paren4">(<span class=""><i><span class="symbol">restas.colorize.view:with-main-menu</span></i><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:href-all</span> <span class="paren6">(<span class="">restas:genurl 'list-pastes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-create</span> <span class="paren6">(<span class="">restas:genurl 'create-paste</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:body</span> <span class="paren6">(<span class="">restas:render-object <span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_find_p.htm" class="symbol">find-package</a> '<span class="keyword">#:restas.colorize.view</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:css</span> <span class="paren4">(<span class="">iter <span class="paren5">(<span class="">for item in '<span class="paren6">(<span class=""><span class="string">"style.css"</span> <span class="string">"colorize.css"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">collect <span class="paren6">(<span class="">restas:genurl 'css <span class="keyword">:file</span> item</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Здесь задаётся <span class="common-lisp-entity">*default-render-method*</span> в виде функции (для упрощения и наглядности используется макрос <span class="common-lisp-entity">restas:define-default-render-method</span>), которая с помощью "пакета с шаблонами" генерирует содержательную часть страницы:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:render-object <span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_find_p.htm" class="symbol">find-package</a> '<span class="keyword">#:restas.colorize.view</span></span>)</span> obj</span>)</span></div></p>
<p>которую затем использует для генерации законченного html-кода.</p>
<p>Ну и конечно, разработчик может определить собственные специализации <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a> для своего типа drawer.</p>
<p>Другим способом отделения логики от представления, который может использоваться, например, когда использование <span class="common-lisp-entity">*default-render-method*</span> не подходит для конкретного маршрута - это параметр :render-method макроса <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>. Например:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> api-method <span class="paren2">(<span class=""><span class="string">"/path/to/method/:(param1)/:(param2)"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:content-type</span> <span class="string">"application/json"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:render-method</span> #'json:encode-json</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_list.htm" class="symbol">list</a> <span class="keyword">:field1</span> <span class="paren3">(<span class="">sql-query <span class="string">"select ..."</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:field2</span> <span class="paren3">(<span class="">sql-query <span class="string">"select ..."</span></span>)</span></span>)</span></span>)</span>)<br>
</div></p>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>