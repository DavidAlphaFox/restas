<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Pastebin</title> <link rel="stylesheet" type="text/css" href="../_static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Framework for web application development in Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Home</a>  </li><li> <a href="../overview.html">Overview</a>  </li><li> <a href="../installation.html">Installation</a>  </li><li> <a href="contents.html">Tutorials</a> <ul> <li> <a href="hello-world.html">Hello World</a> </li><li> <strong>Pastebin</strong> </li> </ul> </li><li> <a href="../manual/contents.html">Manual</a> <ul> <li> <a href="../manual/routes.html">Routes</a> </li><li> <a href="../manual/modules.html">Modules</a> </li><li> <a href="../manual/view.html">View</a> </li><li> <a href="../manual/special-pages.html">Special pages</a> </li><li> <a href="../manual/decorators.html">Decorators</a> </li><li> <a href="../manual/daemon.html">Daemonization</a> </li><li> <a href="../manual/slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="pastebin" class="document"><h1>Pastebin<a href="#pastebin" class="headerlink" title="Permalink to this headline">¶</a></h1><!-- -*- RST -*- -->
<a id="tutorial-pastebin" class="target" name="tutorial-pastebin"></a><p>As a demonstration of using <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> for creation of a full-featured web application I want to show you how to construct a simple pastebin service.</p>
<div class="note admonition-note">
<p class="first">Note</p>
<p class="last">From <a class="reference" href="http://en.wikipedia.org/wiki/Pastebin"><span>Wikipedia </span></a>: A pastebin is a web application which allows its users to upload snippets of text, usually samples of source code, for public viewing. It is very popular in IRC  channels where pasting large amounts of text is considered bad etiquette. A vast number of pastebins exist on the Internet, suiting a number of different needs and provided features tailored towards the crowd they focus on most.</p>
</div>
<p>Pastebin is a simple idea that demonstrates the basic principles of building <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> applications. Apart from this, it is a real application used by the <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> site.  You can see it in action <a class="reference" href="http://lisper.ru/apps/format/"><span>here </span></a>.</p>
<p>The app must have the following abilities:</p>
<ul>
<li><p class="first">A form for creating a new element.</p>
</li>
<li><p class="first">A list of all registered elements, with a way to view them after clicking on an element.</p>
</li>
<li><p class="first">A view for displaying every element.</p>
</li>
<li><p class="first">Syntax highlighting.</p>
</li>
</ul>
<p>Apart from this, pastebin is aimed for using in a context of different sites and hereby must have flexible means of configuration:</p>
<ul>
<li><p class="first">Use the authentication system used by the site.</p>
</li>
<li><p class="first">Use the data storage mechanism provided by the site.</p>
</li>
<li><p class="first">Customising ability for rendering pages.</p>
</li>
</ul>
<div id="logical-structure" class="section"><h2>Logical structure<a href="#logical-structure" class="headerlink" title="Permalink to this headline">¶</a></h2><p>This application is built with classical MVC model and has distinct separation of model, controller, and view.</p>
<p>Customisation of the module is done with special (dynamic) variables (for details about customising modules with dynamic variables see section <a href="../manual/modules.html#modules">Modules</a>).</p>
<p>Pastebin data can be stored in a number of ways. We define an interface and a special variable <span class="common-lisp-entity">*storage*</span>, with which an external application can specify an implementation for storing data. For development and debugging, a developer needs to have a functioning model, which is implemented by a trivial class <span class="common-lisp-entity">memory-storage</span> providing a way of storing data in the memory. Such an approach lets you develop the application without worrying about the structure of a database until you need it.</p>
<p>Usually sites have an unified authentication scheme which should be used in all their components. Therefore the component under development shouldn't know anything about the authentication scheme. In fact, for proper functioning, it needs only to know the username. Consequently, it is enough to introduce just one special variable <span class="common-lisp-entity">*colorize-user-function*</span> that will store a function for figuring out the username.</p>
<p>In order to provide flexible customisation of page view for separation of logic and view, the component uses the special variable <span class="common-lisp-entity">*default-render-method*</span> created by <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> and storing the object in charge of representation (you will find it in more details in the section <a href="../manual/view.html#view">View</a>). And for definition of page templates we use the <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a> library.</p>
<p>For syntax highlighting, we use the <cite><span>colorize</span></cite> library which provides good HTML output.</p>
</div>
<div id="physical-structure" class="section"><h2>Physical structure<a href="#physical-structure" class="headerlink" title="Permalink to this headline">¶</a></h2><p>To simplify understanding of the code structure the following division into files is used:</p>
<ul>
<li><p class="first"><strong><span>defmodule.lisp</span></strong> - definition of the module and, also, special variables for controlling the behaviour of components.</p>
</li>
<li><p class="first"><strong><span>storage.lisp</span></strong> - definition of the interface for used data model, and a simple implementation of this model.</p>
</li>
<li><p class="first"><strong><span>drawer.lisp</span></strong> - interface and implementation of the default drawer object that is used as the value of <span class="common-lisp-entity">*default-render-method*</span>.</p>
</li>
<li><p class="first"><strong><span>drawer.tmpl</span></strong> - templates in <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a> format</p>
</li>
<li><p class="first"><strong><span>routes.lisp</span></strong> - the central part of the application where URL scheme and request handlers are defined.</p>
</li>
</ul>
</div>
<div id="implementation" class="section"><h2>Implementation<a href="#implementation" class="headerlink" title="Permalink to this headline">¶</a></h2><div id="defmodule-lisp" class="section"><h3>defmodule.lisp<a href="#defmodule-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-module</span></i> <span class="keyword">#:restas.colorize</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">#:cl</span> <span class="keyword">#:iter</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:export</span> ..</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">in-package <span class="keyword">#:restas.colorize</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defvar</span></i> <span class="special">*max-on-page*</span> 10</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defvar</span></i> <span class="special">*storage*</span> nil</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defvar</span></i> <span class="special">*colorize-user-function*</span> #'<span class="paren2">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class=""></span>)</span> <span class="string">"anonymous"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> colorize-user <span class="paren2">(<span class=""></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><i><span class="symbol">if</span></i> <span class="special">*colorize-user-function*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">funcall <span class="special">*colorize-user-function*</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Here we define the new module <strong><span>#:restas.colorize</span></strong> (for economy of space the list of exported symbols is omitted) and introduce several special variables for using them in module customisation (variables <span class="common-lisp-entity">*max-on-page*</span> and <span class="common-lisp-entity">*colorize-user-function*</span> come with default values) and also the <span class="common-lisp-entity">colorize-user</span> helper function is defined for figuring out the username.</p>
</div>
<div id="storage-lisp" class="section"><h3>storage.lisp<a href="#storage-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Definition of the <span class="common-lisp-entity">*storage*</span> object interface:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> storage-count-notes <span class="paren2">(<span class="">storage</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Total number of notes"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> storage-list-notes <span class="paren2">(<span class="">storage offset limit</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documenation</span> <span class="string">"List of notes starting with offset, but not more than limit"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> storage-get-note <span class="paren2">(<span class="">storage id</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Get the note by id"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> storage-add-note <span class="paren2">(<span class="">storage note</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Add new note"</span></span>)</span></span>)</span></div></p>
<p>Helper class for storing information about a record:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> note <span class="paren2">(<span class=""></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="paren3">(<span class="">id <span class="keyword">:initarg</span> <span class="keyword">:id</span> <span class="keyword">:initform</span> nil <span class="keyword">:accessor</span> note-id</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">date <span class="keyword">:initarg</span> <span class="keyword">:date</span> <span class="keyword">:initform</span> nil <span class="keyword">:accessor</span> note-date</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">author <span class="keyword">:initarg</span> <span class="keyword">:author</span> <span class="keyword">:initform</span> nil <span class="keyword">:accessor</span> note-author</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">title <span class="keyword">:initarg</span> <span class="keyword">:title</span> <span class="keyword">:initform</span> nil <span class="keyword">:accessor</span> note-title</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">lang <span class="keyword">:initarg</span> <span class="keyword">:lang</span> <span class="keyword">:initform</span> nil <span class="keyword">:accessor</span> note-lang</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">code <span class="keyword">:initarg</span> <span class="keyword">:code</span> <span class="keyword">:initform</span> nil <span class="keyword">:accessor</span> note-code</span>)</span></span>)</span></span>)</span></div></p>
<p>To implement an in-memory storage engine it's enough to just cite the class definition:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> memory-storage <span class="paren2">(<span class=""></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="paren3">(<span class="">notes <span class="keyword">:initform</span> nil</span>)</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">last-id <span class="keyword">:initform</span> 0</span>)</span></span>)</span></span>)</span></div></p>
<p>Setting default value for <span class="common-lisp-entity">*storage*</span> variable:</p>
<p><div class="code"><span class="paren1">(<span class="">setf <span class="special">*storage*</span> <span class="paren2">(<span class="">make-instance 'memory-storage</span>)</span></span>)</span></div></p>
</div>
<div id="routes-lisp" class="section"><h3>routes.lisp<a href="#routes-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p>In this file, processed URLs and the operation logic are defined. Because all view logic is handled by <span class="common-lisp-entity">*default-render-method*</span> object, route handlers should just gather and prepare data to process them with function <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a> (more details on <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> documentation).  The view logic, as I said before, is implemented on the basis of <a class="reference" href="http://code.google.com/p/cl-closure-template/"><span>cl-closure-template</span></a> library which uses <em><span>plist</span></em> as input data format (you can read about using <em><span>property list</span></em> in more detail at <a class="reference" href="http://lisper.ru/pcl/practical-a-simple-database"><span>here </span></a>), so route handlers generate data in this format.</p>
<p>A couple of helper functions to transform record information into <em><span>plist</span></em> format:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> note-plist/short <span class="paren2">(<span class="">note</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">list <span class="keyword">:href</span> <span class="paren3">(<span class="">restas:genurl 'view-note <span class="keyword">:id</span> <span class="paren4">(<span class="">note-id note</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:date</span> <span class="paren3">(<span class="">local-time:format-timestring nil <span class="paren4">(<span class="">note-date note</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> <span class="paren3">(<span class="">note-title note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="paren3">(<span class="">note-author note</span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> note-plist <span class="paren2">(<span class="">note</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">list* <span class="keyword">:title</span> <span class="paren3">(<span class="">note-title note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:code</span> <span class="paren3">(<span class="">note-code note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:lang</span> <span class="paren3">(<span class="">note-lang note</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">note-plist/short note</span>)</span></span>)</span></span>)</span></div></p>
<p>In this code, the following call is of the most interest:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:genurl 'view-note <span class="keyword">:id</span> <span class="paren2">(<span class="">note-id note</span>)</span></span>)</span></div></p>
<p>It generates a URL for viewing a record based on the route name ('view-node) and :id parameters.</p>
<div class="note admonition-note">
<p class="first">Note</p>
<p class="last">In route-based systems, "manual" creation of URLs is not a common practice, because automatic generation considerably increases flexibility of an application and prevents many potential problems. Among other issues, in this case the base URL, which is an address where the module is mounted, is unknown at the module development stage.</p>
</div>
<p>Application entry point:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> main <span class="paren2">(<span class=""><span class="string">""</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">restas:redirect 'list-notes</span>)</span></span>)</span></div></p>
<p>This route processes a request to the base URL where the module is mounted, and simply redirects it to the page with the record list. For redirection <a class="common-lisp-entity" href="../ref/index.html#restas-redirect">restas:redirect</a> function is used which, like <a class="common-lisp-entity" href="../ref/index.html#restas-genurl">restas:genurl</a>, processes the name of a route (and a set of parameters, but 'list-notes route doesn't have them) so there is no need to actually specify the URL.</p>
<p>For displaying the record list, we use a paginated representation, with the number of records on a single page specified by <span class="common-lisp-entity">*max-on-page*</span> (this variable was introduced in <strong><span>defmodule.lisp</span></strong>). So, apart from the record list itself, you need to gather information about overall number of records, and also provide links to previous and next pages:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> list-notes <span class="paren2">(<span class=""><span class="string">"all"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><i><span class="symbol">let*</span></i> <span class="paren3">(<span class=""><span class="paren4">(<span class="">total-count <span class="paren5">(<span class="">storage-count-notes <span class="special">*storage*</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">start <span class="paren5">(<span class="">min <span class="paren6">(<span class="">max <span class="paren1">(<span class="">or <span class="paren2">(<span class="">ignore-errors <span class="paren3">(<span class="">parse-integer <span class="paren4">(<span class="">hunchentoot:get-parameter <span class="string">"start"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total-count</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">list <span class="keyword">:title</span> <span class="string">"All notes"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:notes</span> <span class="paren4">(<span class="">iter <span class="paren5">(<span class="">for note in <span class="paren6">(<span class="">storage-list-notes <span class="special">*storage*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren1">(<span class="">1- start</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="special">*max-on-page*</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">collect <span class="paren6">(<span class="">note-plist/short note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:first</span> start<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:total-count</span> total-count<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-before</span> <span class="paren4">(<span class=""><i><span class="symbol">if</span></i> <span class="paren5">(<span class="">&lt; <span class="paren6">(<span class="">+ <span class="paren1">(<span class="">1- start</span>)</span> <span class="special">*max-on-page*</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total-count</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">format nil<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"~A?start=~A"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">restas:genurl 'list-notes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">+ start <span class="special">*max-on-page*</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-after</span> <span class="paren4">(<span class=""><i><span class="symbol">if</span></i> <span class="paren5">(<span class="">&gt; start 1</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">format nil<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"~A?start=~A"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">restas:genurl 'list-notes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">max <span class="paren1">(<span class="">- start <span class="special">*max-on-page*</span></span>)</span> 1</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>The given code is more entangled than it should be, because the real URL looks like this :</p>
<pre class="literal-block">
all?start=n
</pre><p>(where n is the number of the first record on the page) and the <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> route system doesn't yet know how to handle the GET parameters of a request, hence it borrows <cite><span>Hunchentoot</span></cite> 's <span class="common-lisp-entity">get-parameter</span>.</p>
<p>The following route responds to viewing a particular record:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> view-note <span class="paren2">(<span class=""><span class="string">":id"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:parse-vars</span> <span class="paren3">(<span class="">list <span class="keyword">:id</span> #'parse-integer</span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">note-plist <span class="paren3">(<span class="">storage-get-note <span class="special">*storage*</span> id</span>)</span></span>)</span></span>)</span></div></p>
<p>This handler is very simple, but it contains one interesting moment, the :parse-vars parameter. The identifier of record is ID, which should be an integer. This code ensures that the specified URL contains an integer, and parses it.</p>
<p>The route for displaying the form of creation of a record is yet more trivial:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> create-note <span class="paren2">(<span class=""><span class="string">"create"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">list <span class="keyword">:title</span> <span class="string">"Create"</span></span>)</span></span>)</span></div></p>
<p>This form will support saving and previewing each record, therefore to process a POST request, I used two routes processing the same URL:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> preview-note <span class="paren2">(<span class=""><span class="string">"create"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> #'<span class="paren3">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"preview"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">list <span class="keyword">:title</span> <span class="paren3">(<span class="">hunchentoot:post-parameter <span class="string">"title"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="paren3">(<span class="">colorize-user</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:code</span> <span class="paren3">(<span class="">hunchentoot:post-parameter <span class="string">"code"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:lang</span> <span class="paren3">(<span class="">hunchentoot:post-parameter <span class="string">"lang"</span></span>)</span></span>)</span></span>)</span><br><br>
<br>
<span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> save-note <span class="paren2">(<span class=""><span class="string">"create"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> #'<span class="paren3">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"save"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><i><span class="symbol">let</span></i> <span class="paren3">(<span class=""><span class="paren4">(<span class="">author <span class="paren5">(<span class="">colorize-user</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><i><span class="symbol">if</span></i> author<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">restas:redirect 'view-note<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:id</span> <span class="paren5">(<span class="">note-id <span class="paren6">(<span class="">storage-add-note<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="special">*storage*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren1">(<span class="">make-instance 'note<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:code</span> <span class="paren2">(<span class="">hunchentoot:post-parameter <span class="string">"code"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> author<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:lang</span> <span class="paren2">(<span class="">hunchentoot:post-parameter <span class="string">"lang"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> <span class="paren2">(<span class="">hunchentoot:post-parameter <span class="string">"title"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hunchentoot:+http-forbidden+</span>)</span></span>)</span></span>)</span></div></p>
<p>Route selection is done by the :requirement property that checks which command (Save or Preview) is selected by a user. For checking whether the user has the right to save the record the <span class="common-lisp-entity">colorize-user</span> function (defined in <strong><span>defmodule.lisp</span></strong>). If the user is unauthorised she will receive the <span class="common-lisp-entity">hunchentoot:+http-forbidden+</span> status code.</p>
</div>
<div id="drawer-lisp" class="section"><h3>drawer.lisp<a href="#drawer-lisp" class="headerlink" title="Permalink to this headline">¶</a></h3><p>All routes defined above return data in <em><span>plist</span></em> format, so in order to select a template for processing passed data, the name of current route must be used, which can be evaluated by</p>
<p><div class="code"><span class="paren1">(<span class="">restas:route-symbol <span class="special">restas:*route*</span></span>)</span></div></p>
<p>A generic function is provided for doing this:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> render-route-data <span class="paren2">(<span class="">drawer data route </span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Rendering page for the specified route"</span></span>)</span></span>)</span></div></p>
<p><span class="common-lisp-entity">render-route-data</span> can be specialized with <em><span>eql</span></em> specializer for each particular route.  This function basically renders the HTML output for each route.  E.g. if your page has a header, a sidebar, a content, and a footer, <span class="common-lisp-entity">render-route-data</span> would generate only your <em><span>content</span></em> based on the data.</p>
<p>External applications could redefine the theme and structure of the site with a generic function:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> finalize-page <span class="paren2">(<span class="">drawer data</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"Shaping the resulting page"</span></span>)</span></span>)</span></div></p>
<p>The <a class="reference" href="http://www.cliki.net/colorize"><span>colorize</span></a> library highlights Common Lisp code very well. To leave open the possibility of using some other highlighting libraries the following interfaces are defined with their default implementation on the basis of <a class="reference" href="http://www.cliki.net/colorize"><span>colorize</span></a>:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> colorize <span class="paren2">(<span class="">drawer code lang</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"generation of html with syntax highlight"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:method</span> <span class="paren3">(<span class="">drawer code lang</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">colorize::html-colorization lang code</span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defgeneric</span></i> colorize-langs <span class="paren2">(<span class="">drawer</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:documentation</span> <span class="string">"List of supported languages"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:method</span> <span class="paren3">(<span class="">drawer</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">iter <span class="paren4">(<span class="">for <span class="paren5">(<span class="">id . title</span>)</span> in <span class="paren5">(<span class="">colorize:coloring-types</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">collect <span class="paren5">(<span class="">list <span class="keyword">:id</span> <span class="paren6">(<span class="">symbol-name id</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> title</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>To specialize the call to <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a> and also for implementing the defined interfaces we need a class:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> drawer <span class="paren2">(<span class=""></span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span></div></p>
<p>The implementation of <span class="common-lisp-entity">finalize-page</span> by default just calls the template with the same name:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> finalize-page <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> data</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">restas.colorize.view:finalize-page data</span>)</span></span>)</span></div></p>
<p>Now <a class="common-lisp-entity" href="../ref/index.html#restas-render-object">restas:render-object</a> can be written in the following form:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> restas:render-object <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data list</span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><i><span class="symbol">let</span></i> <span class="paren3">(<span class=""><span class="paren4">(<span class="">content <span class="paren5">(<span class="">render-route-data drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">restas:route-symbol <span class="special">restas:*route*</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">menu <span class="paren5">(<span class="">restas.colorize.view:main-menu<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">list <span class="keyword">:href-all</span> &nbsp;<span class="paren1">(<span class="">restas:genurl 'list-notes</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:href-create</span> <span class="paren1">(<span class="">restas:genurl 'create-note</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">finalize-page drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">list <span class="keyword">:content</span> content<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:menu</span> menu<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:title</span> <span class="paren5">(<span class="">getf data <span class="keyword">:title</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Here takes place a call to <span class="common-lisp-entity">finalize-page</span> with the following data passed passed to it in <em><span>plist</span></em> format:</p>
<ul>
<li><p class="first"><strong><span>content</span></strong> - the basic content of the page as it was generated by call to <span class="common-lisp-entity">render-route-data</span>.</p>
</li>
<li><p class="first"><strong><span>menu</span></strong> - links for viewing records and creating a new record. They are used for displaying the menu identical for all pages.</p>
</li>
<li><p class="first"><strong><span>title</span></strong> - the heading of page extracted from passed data.</p>
</li>
</ul>
<p>The implementation of <span class="common-lisp-entity">render-route-data</span> processes passed data with the aid of a template, whose name matches the name of the passed route (here you can find usage of well known "Prevailing of agreement over configuration"):</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> data route</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">funcall <span class="paren3">(<span class="">find-symbol <span class="paren4">(<span class="">symbol-name route</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="keyword">#:restas.colorize.view</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span></span>)</span></div></p>
<p>Several routes need additional processing of passed data that cannot be done at the template side and this is done with <em><span>eql</span></em>-based specializing:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data list</span>)</span> <span class="paren3">(<span class="">route <span class="paren4">(<span class="">eql 'view-note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">call-next-method drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">list* <span class="keyword">:code</span> <span class="paren4">(<span class="">colorize drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">getf data <span class="keyword">:code</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">getf data <span class="keyword">:lang</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data list</span>)</span> <span class="paren3">(<span class="">route <span class="paren4">(<span class="">eql 'create-note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">call-next-method drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">list* <span class="keyword">:langs</span> <span class="paren4">(<span class="">colorize-langs drawer</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> render-route-data <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer drawer</span>)</span> <span class="paren3">(<span class="">data list</span>)</span> <span class="paren3">(<span class="">route <span class="paren4">(<span class="">eql 'preview-note</span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">call-next-method drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">list* <span class="keyword">:langs</span> <span class="paren4">(<span class="">colorize-langs drawer</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:preview</span> <span class="paren4">(<span class="">colorize drawer<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">getf data <span class="keyword">:code</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">getf data <span class="keyword">:lang</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;route</span>)</span></span>)</span></div></p>
<p>Finally the default value is assigned to <span class="common-lisp-entity">*default-render-method*</span>:</p>
<p><div class="code"><span class="paren1">(<span class="">setf <span class="special">*default-render-method*</span> <span class="paren2">(<span class="">make-instance 'drawer</span>)</span></span>)</span></div></p>
<p>We used a quite complex system for generating contents, which on the one hand is fully based on templates, and on the other hand each of its aspect is defined as a generic function.  So changing the representation it is enough to define a drawer-inherited class and to specialize the required generic functions.</p>
</div>
<div id="drawer-tmpl" class="section"><h3>drawer.tmpl<a href="#drawer-tmpl" class="headerlink" title="Permalink to this headline">¶</a></h3><p>The template file can be compiled with this code:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defparameter</span></i> <span class="special">*colorize-template-path*</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">merge-pathnames <span class="string">"src/drawer.tmpl"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">asdf:component-pathname <span class="paren4">(<span class="">asdf:find-system '<span class="keyword">#:restas-colorize</span></span>)</span></span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">closure-template:compile-template <span class="keyword">:common-lisp-backend</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="special">*colorize-template-path*</span></span>)</span></div></p>
<p>And the file itself has the following content: :</p>
<pre class="literal-block">
{namespace restas.colorize.view}

{template finalizePage}
    &lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
    {\n}
    &lt;html&gt;
        &lt;head&gt;
    	      &lt;meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /&gt;

            {if $title}
                &lt;title&gt;{$title}&lt;/title&gt;
            {/if}
        &lt;/head&gt;

        &lt;body&gt;
          {$menu |noAutoescape}
          
          {$content |noAutoescape}
        &lt;/body&gt;
    &lt;/html&gt;
{/template}

{template main-menu}
    &lt;ul class="colorize-top-menu"&gt;
        &lt;li&gt;
            &lt;a href="{$hrefAll}"&gt;All notes&lt;/a&gt;
        &lt;/li&gt;

        &lt;li&gt;
            &lt;a href="{$hrefCreate}"&gt;Create&lt;/a&gt;
        &lt;/li&gt;
   &lt;/ul&gt;
{/template}

{template show-note-info}
    &lt;div class="info"&gt;
        Author: &lt;strong&gt;{$author}&lt;/strong&gt; - {$date}
    &lt;/div&gt;
{/template}
  
{template list-notes}
    &lt;div class="colorize-list-nav" &gt;
        {if $hrefAfter}&lt;a href="{$hrefAfter}"&gt;« Later&lt;/a&gt;{/if}
        {$first} - {min($first + length($notes) - 1, $totalCount)} 
        of {$totalCount}  
        {if $hrefBefore}&lt;a href="{$hrefBefore}"&gt;Earlier »&lt;/a&gt;{/if}
    &lt;/div&gt;

    {foreach $note in $notes}
        &lt;div class="note"&gt;
            &lt;a href="{$note.href}"&gt;{$note.title != '' ? $note.title : '*notitle*'}&lt;/a&gt;
            {call show-note-info data="$note" /}
        &lt;/div&gt;
    {/foreach}
{/template}

{template view-note}
    &lt;div class="note-detail"&gt;
        &lt;strong&gt;{$title}&lt;/strong&gt;
        {call show-note-info data="all" /}
        &lt;div class="code"&gt;
            {$code |noAutoescape}
        &lt;/div&gt;
    &lt;/div&gt;
{/template}    
  
{template create-note}
    &lt;form method="post"&gt;
        &lt;textarea rows="30" name="code" cols="80" style="width: 100%"&gt;{$code}&lt;/textarea&gt;
        &lt;table style="text-align: left"&gt;
            &lt;tbody&gt;
                {if $preview and $author}
                    &lt;tr&gt;
                        &lt;th&gt;Description:&lt;/th&gt;
                        &lt;td&gt;
                            &lt;input size="60" name="title" type="text" {if $title}value="{$title}"{/if}/&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                {/if}
                  
                &lt;tr&gt;
                    &lt;th&gt;Format as&lt;/th&gt;
                    &lt;td&gt;
                        &lt;select name="lang" &gt;
                            {foreach $l in $langs}
                                &lt;option {if $l.id == $lang}selected{/if} value="{$l.id}"&gt;{$l.title}&lt;/option&gt;
                            {/foreach}
                        &lt;/select&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
      
        &lt;input type="submit" value="Format" name="preview" /&gt;
        {if $preview and $author}
            &lt;input type="submit" value="Save" name="save" /&gt;
        {/if}

        {if $preview}
            &lt;h3&gt;Preview&lt;/h3&gt;
            &lt;div class="code"&gt;
                {$preview |noAutoescape}
            &lt;/div&gt;
        {/if}
   &lt;/form&gt;    
{/template}

{template preview-note}
    {call create-note data="all" /}
{/template}
</pre></div>
</div>
<div id="usage" class="section"><h2>Usage<a href="#usage" class="headerlink" title="Permalink to this headline">¶</a></h2><p>For using the pastebin component on <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> I use the following code:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> pastebin-drawer <span class="paren2">(<span class="">restas.colorize::drawer</span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> restas.colorize::finalize-page <span class="paren2">(<span class=""><span class="paren3">(<span class="">drawer pastebin-drawer</span>)</span> data</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">rulisp-finalize-page &nbsp;<span class="keyword">:title</span> <span class="paren3">(<span class="">getf data <span class="keyword">:title</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:css</span> '<span class="paren3">(<span class=""><span class="string">"style.css"</span> <span class="string">"colorize.css"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:content</span> <span class="paren3">(<span class="">concatenate 'string<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">getf data <span class="keyword">:menu</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">getf data <span class="keyword">:content</span></span>)</span></span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">restas:mount-submodule rulisp-format <span class="paren2">(<span class=""><span class="keyword">#:restas.colorize</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*baseurl*</span> '<span class="paren3">(<span class=""><span class="string">"apps"</span> <span class="string">"format"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*max-on-page*</span> 15</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*storage*</span> <span class="special">*rulisp-db-storage*</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*colorize-user-function*</span> #'compute-user-login-name</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.colorize:*default-render-method*</span> <span class="paren3">(<span class="">make-instance 'pastebin-drawer</span>)</span></span>)</span></span>)</span></div></p>
<p>Here variables are specified with <em><span>dynamic variable binding</span></em>: the base URL where the module is mounted, maximum number of records per page, data storage mechanism, authentication mechanism, and also a way of displaying pages for the component in the same design style.</p>
</div>
<div id="source-code" class="section"><h2>Source code<a href="#source-code" class="headerlink" title="Permalink to this headline">¶</a></h2><p>The source code of described application is available at the address <a class="reference" href="http://github.com/archimag/restas-colorize"><span>http://github.com/archimag/restas-colorize</span></a>.  Not taking in account the template file, the size of the source code is about 200 lines.</p>
</div>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>