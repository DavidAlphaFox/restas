<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Decorators</title> <link rel="stylesheet" type="text/css" href="../_static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Framework for web application development in Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Home</a>  </li><li> <a href="../overview.html">Overview</a>  </li><li> <a href="../installation.html">Installation</a>  </li><li> <a href="../tutorial/contents.html">Tutorials</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Manual</a> <ul> <li> <a href="routes.html">Routes</a> </li><li> <a href="modules.html">Modules</a> </li><li> <a href="view.html">View</a> </li><li> <a href="special-pages.html">Special pages</a> </li><li> <strong>Decorators</strong> </li><li> <a href="daemon.html">Daemonization</a> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="decorators" class="document"><h1>Decorators<a href="#decorators" class="headerlink" title="Permalink to this headline">¶</a></h1><!-- -*- RST -*- -->
<a id="manual-decorators" class="target" name="manual-decorators"></a><p>One of the attractive features of applications based on <a class="reference" href="http://en.wikipedia.org/wiki/Web_Server_Gateway_Interface"><span>WSGI</span></a> is the use of "middleware" components. <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> has similar capabilities provided by decorators.  This is done by using <span class="common-lisp-entity">routes:proxy-route</span> to create a wrapper over the routes and redefining their behaviors by specializing on the associated generic functions.</p>
<p><strong><span>Decorator</span></strong> - a function that takes the route and returns a different route.</p>
<p>Decorators can be used for many purposes including:</p>
<ul>
<li><p class="first">Authentication/authorization</p>
</li>
<li><p class="first">Fine-tuning response headers</p>
</li>
<li><p class="first">Environment settings used for request processing</p>
</li>
</ul>
<p>For example, to completely prevent caching in browsers you can define a decorator named <span class="common-lisp-entity">@no-cache</span> like so:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> no-cache-route <span class="paren2">(<span class="">routes:proxy-route</span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> process-route <span class="keyword">:before</span> <span class="paren2">(<span class=""><span class="paren3">(<span class="">route no-cache-route</span>)</span> bindings</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">setf <span class="paren3">(<span class="">hunchentoot:header-out <span class="keyword">:expires</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">hunchentoot:rfc-1123-date</span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">setf <span class="paren3">(<span class="">hunchentoot:header-out <span class="keyword">:cache-control</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"max-age=0, no-store, no-cache, must-revalidate"</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> @no-cache <span class="paren2">(<span class="">route</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">make-instance 'no-cache-route <span class="keyword">:target</span> route</span>)</span></span>)</span></div></p>
<p>Now you can use the decorator when defining a route:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> main <span class="paren2">(<span class=""><span class="string">""</span> <span class="keyword">:decorators</span> '<span class="paren3">(<span class="">@no-cahe</span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="string">"&lt;h1&gt;Hello world!&lt;/h1&gt;"</span></span>)</span></div></p>
<p>It can also be applied to the whole module:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-module</span></i> <span class="keyword">#:restas.hello-world</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">:cl</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:decorators</span> #'restas:@no-caсhe</span>)</span></span>)</span></div></p>
<p>Or even when mounting a submodule:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:mount-submodule test-hello-world <span class="paren2">(<span class=""><span class="keyword">#:hello-world</span> restas:@no-caсhe</span>)</span></span>)</span></div></p>
<p>All routes, which are defined through <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, are passed through a series of decorators before being placed in the dispatch tree.  The decorators listed in <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a> are applied first, then the decorators listed in <a class="common-lisp-entity" href="../ref/index.html#restas-define-module">restas:define-module</a>, and finally the decorators listed in <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a>.  Thus, a chain of nested proxy objects is inserted into the dispatch tree instead of the original <span class="common-lisp-entity">restas:route</span> object.</p>
<p>To define a new decorator, you need to define a new class that inherits from <span class="common-lisp-entity">routes:proxy-route</span>, then define a function to create an object of this class from the original route, and define the specialized methods on the following generic functions:</p>
<ul>
<li><p class="first"><span class="common-lisp-entity">routes:route-check-conditions</span> (route bindings) - called when the route template URL matches the request URL, allowing you to define additional restrictions.  If this function returns <a href="" class="common-lisp-entity">T</a>, the route is considered to satisfy the request; in case of <a href="" class="common-lisp-entity">NIL</a> the route is discarded and the system moves on to try the next route.</p>
</li>
<li><p class="first"><span class="common-lisp-entity">restas:process-route</span> (route bindings) - called for actual request handling.</p>
</li>
</ul>
<p>Below is an example of using a decorator for HTTP authentication when browsing a directory published via <a class="reference" href="http://github.com/archimag/restas-directory-publisher"><span>restas-directory-publisher</span></a>.</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">defclass</span></i> http-auth-route <span class="paren2">(<span class="">routes:proxy-route</span>)</span> <span class="paren2">(<span class=""></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defmethod</span></i> routes:route-check-conditions <span class="paren2">(<span class=""><span class="paren3">(<span class="">route http-auth-route</span>)</span> bindings</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">and <span class="paren3">(<span class="">call-next-method</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class="">multiple-value-bind <span class="paren4">(<span class="">user password</span>)</span> <span class="paren4">(<span class="">hunchentoot:authorization</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">or <span class="paren5">(<span class="">and <span class="paren6">(<span class="">string= user <span class="string">"hello"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren6">(<span class="">string= password <span class="string">"world"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">hunchentoot:require-authorization</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">defun</span></i> @http-auth-require <span class="paren2">(<span class="">route</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">make-instance 'http-auth-route <span class="keyword">:target</span> route</span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">restas:mount-submodule -tmp- <span class="paren2">(<span class=""><span class="keyword">#:restas.directory-publisher</span> @http-auth-require</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*baseurl*</span> '<span class="paren3">(<span class=""><span class="string">"tmp"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*directory*</span> #P<span class="string">"/tmp/"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*autoindex*</span> t</span>)</span></span>)</span></div></p>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>