<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Modules</title> <link rel="stylesheet" type="text/css" href="../static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Framework for web application development in Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Home</a>  </li><li> <a href="../overview.html">Overview</a>  </li><li> <a href="../installation.html">Installation</a>  </li><li> <a href="../tutorial/contents.html">Tutorials</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Manual</a> <ul> <li> <a href="routes.html">Routes</a> </li><li> <strong>Modules</strong> </li><li> <a href="view.html">View</a> </li><li> <a href="special-pages.html">Special pages</a> </li><li> <a href="decorators.html">Decorators</a> </li><li> <a href="daemon.html">Daemonization</a> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="modules" class="document"><h1>Modules<a href="#modules" class="headerlink" title="Permalink to this headline">¶</a></h1><h2 id="module">Module<a href="#module" class="headerlink" title="Permalink to this headline">¶</a></h2><a id="manual-modules" class="target" name="manual-modules"></a><p>From the Common Lisp point of view a module is just a <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_pkg.htm" class="common-lisp-entity">package</a>. From the RESTAS point of view a module is a set of routes defining web application structure. Modules are created with macro <a class="common-lisp-entity" href="../ref/index.html#restas-define-module">restas:define-module</a> which creates a package with corresponding name and performs some additional initialization. For example:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-module</span></i> <span class="keyword">#:hello-world</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">#:cl</span></span>)</span></span>)</span></div></p>
<p>Now you can create several routes in this module:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_in_pkg.htm" class="symbol">in-package</a> <span class="keyword">#:hello-world</span></span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> main <span class="paren2">(<span class=""><span class="string">"hello"</span></span>)</span><br>&nbsp;&nbsp;<span class="string">"&lt;h1&gt;Hello world!&lt;/h1&gt;"</span></span>)</span></div></p>
<p>I should point out the principal importance of macroexpansion of <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a> in the package (after <a href="http://www.lispworks.com/reference/HyperSpec/Body/m_in_pkg.htm" class="common-lisp-entity">in-package</a>) bound to the particular module.</p>
<p>Finally, obtained module can be launched as a site:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:start '<span class="keyword">#:hello-world</span> <span class="keyword">:port</span> 8080</span>)</span></div></p>
<p>You can also pass the :hostname keyword parameter to the function <a class="common-lisp-entity" href="../ref/index.html#restas-start">restas:start</a> and it will let you serve several virtual hosts within one process.</p>
<p>Thus, after placing several routes in a module you can use the module for launching of a web application. But, also, there is another way of using modules.</p>
<div id="submodules" class="section"><h2>Submodules<a href="#submodules" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Modules propose interesting way of code reuse for web application development. The difference of a web component from an usual library containing functions, macros, classes and other stuff is that the web component must also contain information about served URLs and this information must be used by the request dispatch mechanism and correctly identify the code responsible for processing the incoming request. In the terms of routes every reused web component is just a list of routes processed by it, and this is just what modules are from the RESTAS point of view. For using a module from another module one can use <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a> . Example (depends on the code above):</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-module</span></i> <span class="keyword">#:test</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="keyword">:use</span> <span class="keyword">#:cl</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_in_pkg.htm" class="symbol">in-package</a> <span class="keyword">#:test</span></span>)</span><br><br>
<span class="paren1">(<span class="">restas:mount-submodule test-hello-world <span class="paren2">(<span class=""><span class="keyword">#:hello-world</span></span>)</span></span>)</span><br><br>
<span class="paren1">(<span class="">restas:start '<span class="keyword">#:test</span> <span class="keyword">:port</span> 8080</span>)</span></div></p>
<p>In the given example we have defined new module 'test and attached the above-defined module 'hello-world to it (resulting submodule is associated with symbol 'test-hello-world) and module 'test was started at port 8080. Despite no route being defined inside the 'test module, it is able to process requests coming to /hello because it includes 'hello-world module.</p>
<p>Module configuration is done via dynamic variables. Here is an example of the code used by <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> for publishing static files:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:mount-submodule rulisp-static <span class="paren2">(<span class=""><span class="keyword">#:restas.directory-publisher</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*directory*</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_merge_.htm" class="symbol">merge-pathnames</a> <span class="string">"static/"</span> <span class="special">*resources-dir*</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*autoindex*</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="symbol">nil</a></span>)</span></span>)</span></div></p>
<p>In this example we use the <a class="reference" href="http://github.com/archimag/restas-directory-publisher"><span>restas-directory-publisher</span></a> module.</p>
<p>The  module defines several dynamic variables which can later be used for configuration. In <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a> some of these variables are bound to new values - these bindings are not applied directly but are saved as a context for future use. At request processing time the dispatcher finds the route, identifies the module related to it, adjusts environment on the basis of the saved context and makes further processing of the request inside this environment (using special operator <a href="http://www.lispworks.com/reference/HyperSpec/Body/s_progv.htm" class="common-lisp-entity">progv</a>). This mechanism resembles Buffer-Local Variables in Emacs.</p>
<p>When defining a new module with <a class="common-lisp-entity" href="../ref/index.html#restas-define-module">restas:define-module</a> the <span class="common-lisp-entity">*baseurl*</span> variable is added to it (to its <a href="http://www.lispworks.com/reference/HyperSpec/Body/t_pkg.htm" class="common-lisp-entity">package</a>). This variable should be a list of strings that defines a base URL where the module is mounted. It is set to <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_nil.htm" class="common-lisp-entity">nil</a> by default. This variable can be used in <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a> for specifying where the submodule will be plugged in. Here is a more complex example of the module <a class="reference" href="http://github.com/archimag/restas-directory-publisher"><span>restas-directory-publisher</span></a> of <a class="reference" href="http://lisper.ru/"><span>lisper.ru</span></a> (you can see it in action at address <a class="reference" href="http://lisper.ru/files/"><span>http://lisper.ru/files/</span></a>).</p>
<p><div class="code"><span class="paren1">(<span class="">restas:mount-submodule rulisp-files <span class="paren2">(<span class=""><span class="keyword">#:restas.directory-publisher</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*baseurl*</span> '<span class="paren3">(<span class=""><span class="string">"files"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*directory*</span> <span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_merge_.htm" class="symbol">merge-pathnames</a> <span class="string">"files/"</span> <span class="special">*vardir*</span></span>)</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><span class="special">restas.directory-publisher:*autoindex-template*</span><br>&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_lambda.htm" class="symbol"><i><span class="symbol">lambda</span></i></a> <span class="paren4">(<span class="">data</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">rulisp-finalize-page <span class="keyword">:title</span> <span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_getf.htm" class="symbol">getf</a> data <span class="keyword">:title</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:css</span> '<span class="paren5">(<span class=""><span class="string">"style.css"</span> <span class="string">"autoindex.css"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:content</span> <span class="paren5">(<span class="">restas.directory-publisher.view:autoindex-content data</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>By the way this example coupled to preceding ones shows double usage of the same module with different operation modes within the bounds of the same site without any conflicts between them.</p>
</div>
<div id="internal-initialization" class="section"><h2>Internal initialization<a href="#internal-initialization" class="headerlink" title="Permalink to this headline">¶</a></h2><p>The macro <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a> lets you control module customization "from outside", but sometimes you need the possibility to control created context inside the module. E.g. module <a class="reference" href="http://github.com/archimag/restas-planet"><span>restas-planet</span></a> used for organizing <a class="reference" href="http://lisper.ru/planet/"><span>Russian Lisp Planet</span></a> requires a mechanism to save a robot object (which periodically reads feeds and merges them into a single one), which should be computed on the basis of variables which can be placed in submodule's context. For such cases a generic function <span class="common-lisp-entity">restas:define-initialization</span> is provided. Here is the real code from planet.lisp:</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> restas:initialize-module-instance <span class="keyword">:before</span> <span class="paren2">(<span class=""><span class="paren3">(<span class="">module <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> #.*package*</span>)</span></span>)</span> context</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><i><span class="symbol">restas:with-context</span></i> context<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">when</a> <span class="special">*feeds*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">restas:context-add-variable<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'<span class="special">*spider*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_mk_ins.htm" class="symbol">make-instance</a> 'spider<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:feeds</span> <span class="special">*feeds*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:schedule</span> <span class="special">*schedule*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:cache-dir</span> <span class="paren6">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_if.htm" class="symbol"><i><span class="symbol">if</span></i></a> <span class="special">*cache-dir*</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_ensu_1.htm" class="symbol">ensure-directories-exist</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/f_merge_.htm" class="symbol">merge-pathnames</a> <span class="string">"spider/"</span> <span class="special">*cache-dir*</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></div></p>
<p>Here the computation of 'spider' object is made and the object is associated with variable <span class="common-lisp-entity">*spider*</span> and is placed in the context of created submodule. The present code will be evaluated during evaluation of the <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a> form. Considering creation of a spider object leads to launching a scheduler (in particular, a timer is created) we need to know how to stop it when evaluating <a class="common-lisp-entity" href="../ref/index.html#restas-mount-submodule">restas:mount-submodule</a> in the second time. The generic function <span class="common-lisp-entity">restas:define-finalization</span> is provided for this.</p>
<p><div class="code"><span class="paren1">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_defmet.htm" class="symbol"><i><span class="symbol">defmethod</span></i></a> restas:finalize-module-instance <span class="keyword">:after</span> <span class="paren2">(<span class=""><span class="paren3">(<span class="">module <span class="paren4">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/a_eql.htm" class="symbol">eql</a> #.*package*</span>)</span></span>)</span> context</span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/s_let_l.htm" class="symbol"><i><span class="symbol">let</span></i></a> <span class="paren3">(<span class=""><span class="paren4">(<span class="">spider <span class="paren5">(<span class="">restas:context-symbol-value context '<span class="special">*spider*</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><a href="http://www.lispworks.com/reference/HyperSpec/Body/m_when_.htm" class="symbol">when</a> spider<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren4">(<span class="">spider-stop-scheduler spider</span>)</span></span>)</span></span>)</span></span>)</span></div></p>
</div>
<div id="dualism" class="section"><h2>Dualism<a href="#dualism" class="headerlink" title="Permalink to this headline">¶</a></h2><p>The described scheme implies a dualism: a module as a standalone application and the same module as a reusable component. This lets you to develop a module without planning for reuse, and later make it into a reusable component at minimal cost (just by bringing it to the "right" design). This approach bypasses many of the problems of traditional OO design.</p>
<p>As a demonstration, here is the code for launching <a class="reference" href="http://github.com/archimag/restas-directory-publisher"><span>restas-directory-publisher</span></a>, which I used above as a reusable component, as a standalone application:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:start '<span class="keyword">#:restas.directory-publisher</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:port</span> 8080<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:context</span> <span class="paren2">(<span class="">restas:make-context <span class="paren3">(<span class=""><span class="special">restas.directory-publisher:*baseurl*</span> '<span class="paren4">(<span class=""><span class="string">"tmp"</span></span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><span class="special">restas.directory-publisher:*directory*</span> #P<span class="string">"/tmp/"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren3">(<span class=""><span class="special">restas.directory-publisher:*autoindex*</span> <a href="http://www.lispworks.com/reference/HyperSpec/Body/a_t.htm" class="symbol">t</a></span>)</span></span>)</span></span>)</span></div></p>
<p>Now if you open <a class="reference" href="http://localhost:8080/tmp/"><span>http://localhost:8080/tmp/</span></a> in your browser you can observe the content of the #P"/tmp/" directory.</p>
</div>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>