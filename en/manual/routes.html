<html> <head> <meta http-equiv="Content-Type" content="text/html; charset='utf-8'" /> <meta name="keywords" content="restas,web,framework,web framework,REST,Common Lisp,lisp" /> <title>Routes</title> <link rel="stylesheet" type="text/css" href="../_static/style.css" /> </head> <body> <a href="http://github.com/archimag/restas/"> <img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"> </a> <div id="frame"> <div id="page-title"> <h1>RESTAS</h1> <b>Framework for web application development in Common Lisp</b> </div> <div id="menu"> <ul> <li> <a href="../index.html">Home</a>  </li><li> <a href="../overview.html">Overview</a>  </li><li> <a href="../installation.html">Installation</a>  </li><li> <a href="../tutorial/contents.html">Tutorials</a> <ul> <li> <a href="../tutorial/hello-world.html">Hello World</a> </li><li> <a href="../tutorial/pastebin.html">Pastebin</a> </li> </ul> </li><li> <a href="contents.html">Manual</a> <ul> <li> <strong>Routes</strong> </li><li> <a href="modules.html">Modules</a> </li><li> <a href="view.html">View</a> </li><li> <a href="special-pages.html">Special pages</a> </li><li> <a href="decorators.html">Decorators</a> </li><li> <a href="daemon.html">Daemonization</a> </li><li> <a href="slime.html">SLIME</a> </li> </ul> </li><li> <a href="../ref/index.html">API Reference</a>  </li> </ul> </div> <div id="content"> <div id="routes" class="document"><h1>Routes<a href="#routes" class="headerlink" title="Permalink to this headline">¶</a></h1><a id="manual-routes" class="target" name="manual-routes"></a><p>The idea of routes originally appeared in <a class="reference" href="http://rubyonrails.org/"><span>Ruby On Rails</span></a> and rapidly became popular among other web frameworks. Also, <a class="reference" href="http://www.djangoproject.com/"><span>Django</span></a>'s <a class="reference" href="http://docs.djangoproject.com/en/dev/topics/http/urls/"><span>URLConf</span></a> is a conceptually very similar system. Among subsequent developments, <a class="reference" href="http://routes.groovie.org/"><span>http://routes.groovie.org/</span></a> (used by <a class="reference" href="http://pylonshq.com/"><span>Pylons</span></a>) is probably the most powerful implementation of this idea.</p>
<p>Routes deal with the key problem of web development: matching code to URL.  For example, which code should respond to processing request to "/blog/2008/01/08" or "/login" path? Many frameworks use a fixed dispatch system, e.g. "/A/B/C" means read file "C" in directory "B", or call method "C" of class "B" in module "A". This works fine until you decide to reorganize the code, in which case it breaks bookmarks, and forces you to change the already debugged logic of link generation inside the site.</p>
<p>Routes offer another approach. You define a URL template and bind it to your code. If you change your decision about a particular URL, you will just change the URL template - your code will continue to work fine without having to change any logic.</p>
<div id="id1" class="section"><h2>cl-routes<a href="#id1" class="headerlink" title="Permalink to this headline">¶</a></h2><p>Routes are the key concept of <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a>, and their implementation is based on <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> library.</p>
<p>Here are several URL templates for <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> library. :</p>
<pre class="literal-block">
/forum/:chapter/:topic/:message
/forum/archives/:year/:month/:day
/forum/:chapter/rss
</pre><p>Or joining strings: :</p>
<pre class="literal-block">
/book/:(name)-:(chapter).html
/:(feed).:(format)
</pre><p>Also there are wildcard parameters (with limitation to using each parameter once only in each template) :</p>
<pre class="literal-block">
/mydoc/*items
/*path/rss
</pre><p>The majority of route implementations (including dispatch systems of <a class="reference" href="http://rubyonrails.org/"><span>Ruby On Rails</span></a>, <a class="reference" href="http://www.djangoproject.com/"><span>Django</span></a>, and <a class="reference" href="http://pylonshq.com/"><span>Pylons</span></a>) store routes in a plain list, and the search for a matching route is made with brute force up to first match. Usually, for matching a request and a route they use regular expressions. So for big sites having hundreds (or even thousands) of routes, the dispatch system can become a bottleneck, notably lowering overall performance. <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> compiles all routes in one tree, because searching in a tree for majority of real sites will be noticeably more efficient, and instead of regular expressions it uses a lightweight unification mechanism.</p>
<p>Apart from this, in contrast to above mentioned systems, <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a>'s route isn't a string, but an object of class <span class="common-lisp-entity">routes:route</span>, for which one can specialize <a class="reference" href="http://www.lispworks.com/documentation/HyperSpec/Body/26_glo_g.htm#generic_function"><span>generic</span></a> method <span class="common-lisp-entity">routes:routes:route-check-conditions</span>, that allows making arbitrary checks and comparisons between a route and a request. This possibility is used by <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> for implementing more flexible dispatching.</p>
<p>During specifying routes conflicts are possible when one and the same URL matches several templates. In systems with sequential search of matching route the first match is always picked, and <a class="reference" href="http://github.com/archimag/cl-routes"><span>cl-routes</span></a> tries to select the most specific route, for example, the route having more variables, or having the longest static part. Now there is no accurate description of the collision resolution algorithm, but usually there is no problem with it: the system behaviour is quite reasonable and mainly meets intuitive expectations.</p>
</div>
<div id="usage" class="section"><h2>Usage<a href="#usage" class="headerlink" title="Permalink to this headline">¶</a></h2><p>For a route creation <a class="reference" href="http://restas.lisper.ru/"><span>RESTAS</span></a> uses macro <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a> e.g.:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> article <span class="paren2">(<span class=""><span class="string">"articles/:author/:item"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:get</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:content-type</span> <span class="string">"text/plain"</span></span>)</span><br>&nbsp;&nbsp;<span class="paren2">(<span class="">format nil <span class="string">"Author: ~A~Article: ~A"</span> author item</span>)</span></span>)</span><br>
</div></p>
<p>In other words, we define an URL template and its handler, meanwhile the handler body have immediate access to the variables defined in the URL template. Embedded handler by default may return <a href="" class="common-lisp-entity">string</a>  or "octets <a href="" class="common-lisp-entity">array</a>", or integer number (which will be interpreted as a code of request status), or <a href="" class="common-lisp-entity">pathname</a> (in this case <span class="common-lisp-entity">hunchentoot:handle-static-file</span>) is called, which, contrary to Ruby- and Python-based systems, works fast enough and usually there is no need for additional servers for static content, such as the <a class="reference" href="http://sysoev.ru/nginx/"><span>nginx</span></a> server.</p>
<p>When you define a route with <span class="common-lisp-entity">restas:define-route</span> you need to specify <a href="" class="common-lisp-entity">symbol</a> (in cited example it is 'article), which will became the route name. Firstly, it gives you the possibility to redefine the route (including the URL template, just keep the same name for it) at any moment you want, just send the code to REPL (for example, with M-C-x in <a class="reference" href="http://common-lisp.net/project/slime/"><span>SLIME</span></a>). Secondly, it lets you use this <a href="" class="common-lisp-entity">symbol</a> for URL generation:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:genurl 'article<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="string">"archimag"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:item</span> <span class="string">"introduction-to-routes"</span></span>)</span></div></p>
<p>or for a redirect:</p>
<p><div class="code"><span class="paren1">(<span class="">restas:redirect 'article<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:author</span> <span class="string">"archimag"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:item</span> <span class="string">"introduction-to-routes"</span></span>)</span></div></p>
<p>For one and the same URL template you can create several routes by setting additional requirements to them.</p>
<div id="http-method-type-requirement" class="section"><h3>HTTP method type requirement<a href="#http-method-type-requirement" class="headerlink" title="Permalink to this headline">¶</a></h3><p>This requirement is specified with :method parameter (:get by default) of macro <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, for example:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> view-page <span class="paren2">(<span class=""><span class="string">":page"</span></span>)</span><br>&nbsp;&nbsp;&nbsp;...</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> change-page <span class="paren2">(<span class=""><span class="string">":page"</span> <span class="keyword">:method</span> <span class="keyword">:post</span></span>)</span><br>&nbsp;&nbsp;&nbsp;...</span>)</span></div></p>
<p>Here routes view-page and change-page serve one and the same URL, but view-page is in charge of GET requests, and change-page processes POST requests.</p>
</div>
<div id="url-parameter-control" class="section"><h3>URL parameter control<a href="#url-parameter-control" class="headerlink" title="Permalink to this headline">¶</a></h3><p>Often there is a need to put a restriction to URL template parameters, e.g. a restriction of type, or a need to transform them from a string representation to some objects. For this you can use :parse-vars parameter of macro <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a>, for example:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">restas:define-route</span></i> myroute <span class="paren2">(<span class=""><span class="string">"/foo/:bar/:id/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:parse-vars</span> <span class="paren3">(<span class="">list <span class="keyword">:bar</span> <span class="paren4">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren5">(<span class="">str</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="paren5">(<span class="">check-bar str</span>)</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:id</span> #'parse-integer</span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span></div></p>
<p>Here id parameter is parsed as integer, bar is checked with aid of #'check-bar function, and page parameter is left as is. If a parse function returns <a href="" class="common-lisp-entity">NIL</a> or generates an error, then the route is considered as not meeting the condition and is skipped. In the case of success route body has the access to already parsed parameter value, as returned by specified function.</p>
<a id="manual-routes-requirement" class="target" name="manual-routes-requirement"></a></div>
<div id="arbitrary-restriction" class="section"><h3>Arbitrary restriction<a href="#arbitrary-restriction" class="headerlink" title="Permalink to this headline">¶</a></h3><p>With :requirement parameter of macro <a class="common-lisp-entity" href="../ref/index.html#restas-define-route">restas:define-route</a> you can specify an arbitrary function to be called when the route is checked. If it returns <a href="" class="common-lisp-entity">NIL</a> then the route is treated as inappropriate.</p>
<p>For example, <a class="reference" href="http://github.com/archimag/restas-wiki"><span>restas-wiki</span></a> for processing of editing form of wiki page uses the following code:</p>
<p><div class="code"><span class="paren1">(<span class=""><i><span class="symbol">define-route</span></i> edit-wiki-page/preview <span class="paren2">(<span class=""><span class="string">"edit/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> <span class="paren3">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"preview"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">define-route</span></i> edit-wiki-page/cancel <span class="paren2">(<span class=""><span class="string">"edit/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> <span class="paren3">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"cancel"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span><br><br>
<span class="paren1">(<span class=""><i><span class="symbol">define-route</span></i> edit-wiki-page/save <span class="paren2">(<span class=""><span class="string">"edit/:page"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:method</span> <span class="keyword">:post</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">:requirement</span> <span class="paren3">(<span class=""><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class=""></span>)</span> <span class="paren4">(<span class="">hunchentoot:post-parameter <span class="string">"save"</span></span>)</span></span>)</span></span>)</span><br>&nbsp;&nbsp;...</span>)</span></div></p>
<p>Here the routes edit-wiki-page/preview, edit-wiki-page/cancel, and edit-wiki-page/save reply for pressing form buttons Preview, Cancel, and Save accordingly.</p>
</div>
</div>
</div> </div> </div> <div class="bottom">@2009-2011 <a href="mailto:archimag@gmail.com">Moskvitin Andrey</a></div> </body> </html>